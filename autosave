return function(SaveManager)
    local AUTOSAVE = "autosave"
    local saving   = false
    local folder   = SaveManager.Folder .. "/settings"

    -- Thu thập option -> obj từ SaveManager.Parser.Save
    local function collect_raw()
        local raw = {}
        for idx,opt in pairs(SaveManager.Options) do
            if SaveManager.Parser[opt.Type] and not SaveManager.Ignore[idx] then
                local ok,obj = pcall(SaveManager.Parser[opt.Type].Save, idx, opt)
                if ok and obj then raw[obj.idx or idx] = obj end
            end
        end
        return raw
    end

    local function esc(s)
        s = tostring(s or ""):gsub("\\","\\\\"):gsub('"','\\"')
        return s
    end

    -- ===== Ghi file nhóm theo loại =====
    local function writeLuaConfig()
        local raw = collect_raw()
        local groups = { Toggles = {}, Dropdowns = {}, Inputs = {}, Sliders = {} }

        for k,obj in pairs(raw) do
            if obj.type == "Toggle" then
                groups.Toggles[k] = obj.value == true
            elseif obj.type == "Input" then
                groups.Inputs[k] = tostring(obj.text or "")
            elseif obj.type == "Dropdown" then
                if obj.mutli or obj.multi then -- ✅ sửa typo
                    groups.Dropdowns[k] = obj.value or {}
                else
                    groups.Dropdowns[k] = tostring(obj.value or "")
                end
            elseif obj.type == "Slider" then
                groups.Sliders[k] = tonumber(obj.value or 0)
            end
        end

        local function serialize(tbl, indent)
            indent = indent or "    "
            local lines = {"{"}
            local keys = {}
            for k,_ in pairs(tbl) do keys[#keys+1] = k end
            table.sort(keys, function(a,b) return tostring(a) < tostring(b) end)

            for _,k in ipairs(keys) do
                local v   = tbl[k]
                local key = tostring(k)
                local val
                if type(v) == "string" then
                    val = string.format('"%s"', esc(v))
                elseif type(v) == "table" then
                    local sub = {"{"}
                    local is_array = (#v > 0)
                    if is_array then
                        for i=1,#v do
                            sub[#sub+1] = string.format("%s    \"%s\",", indent, esc(v[i]))
                        end
                    else
                        local sk = {}
                        for kk,_ in pairs(v) do sk[#sk+1]=kk end
                        table.sort(sk, function(a,b) return tostring(a) < tostring(b) end)
                        for _,kk in ipairs(sk) do
                            sub[#sub+1] = string.format("%s    [\"%s\"] = %s,", indent, esc(kk), tostring(v[kk] and true or false))
                        end
                    end
                    sub[#sub+1] = indent.."}"
                    val = table.concat(sub, "\n")
                else
                    val = tostring(v)
                end
                lines[#lines+1] = string.format("%s%s = %s,", indent, key, val)
            end
            lines[#lines+1] = (indent:sub(1, -5) or "").."}"
            return table.concat(lines, "\n")
        end

        local out = {"getgenv().Config = {"}
        out[#out+1] = "    Toggles = "..serialize(groups.Toggles, "        ")..","
        out[#out+1] = "    Dropdowns = "..serialize(groups.Dropdowns, "        ")..","
        out[#out+1] = "    Inputs = "..serialize(groups.Inputs, "        ")..","
        out[#out+1] = "    Sliders = "..serialize(groups.Sliders, "        ")..","
        out[#out+1] = "}"

        if not isfolder(SaveManager.Folder) then makefolder(SaveManager.Folder) end
        if not isfolder(folder) then makefolder(folder) end
        local path = folder.."/"..AUTOSAVE..".lua"
        writefile(path, table.concat(out, "\n"))

        local autoload = folder.."/autoload.txt"
        if not isfile(autoload) then writefile(autoload, AUTOSAVE) end
    end

    -- debounce autosave
    local function autosave()
        if saving then return end
        saving = true
        task.delay(0.25, function()
            pcall(writeLuaConfig)
            saving = false
        end)
    end

    -- hook autosave cho từng option
    local function hook(opt)
        if type(opt) ~= "table" then return end
        if type(opt.OnChanged) == "function" then pcall(function() opt:OnChanged(autosave) end) end
        if type(opt.SetValue) == "function" then
            local o = opt.SetValue
            opt.SetValue = function(self, ...)
                local r = o(self, ...)
                autosave()
                return r
            end
        end
    end
    for _,opt in pairs(SaveManager.Options) do hook(opt) end
    do
        local opts = SaveManager.Options
        local mt = getmetatable(opts) or {}
        local old = mt.__newindex
        mt.__newindex = function(t, k, v)
            rawset(t, k, v); hook(v)
            if type(old) == "function" then pcall(old, t, k, v) end
        end
        setmetatable(opts, mt)
    end

    --------------------------------------------------------------------
    -- ✅ ƯU TIÊN getgenv().Config (runtime) TRƯỚC autosave.lua
    --------------------------------------------------------------------
    local function __apply_table_to_options(tbl)
        for key, val in pairs(tbl or {}) do
            local opt = SaveManager.Options[key]
            if opt then
                if opt.Type == "Toggle" then
                    pcall(function() opt:SetValue(val == true) end)
                elseif opt.Type == "Input" then
                    pcall(function() opt:SetValue(tostring(val or "")) end)
                elseif opt.Type == "Dropdown" then
                    pcall(function()
                        if opt.Multi then
                            opt:SetValue(type(val)=="table" and val or {})
                        else
                            opt:SetValue(val ~= nil and val or "")
                        end
                    end)
                elseif opt.Type == "Slider" then
                    pcall(function() opt:SetValue(tonumber(val) or 0) end)
                end
            end
        end
    end

    local function __apply_runtime_config(cfg)
        if type(cfg) ~= "table" then return false end
        if cfg.Toggles or cfg.Dropdowns or cfg.Inputs or cfg.Sliders then
            __apply_table_to_options(cfg.Toggles)
            __apply_table_to_options(cfg.Dropdowns)
            __apply_table_to_options(cfg.Inputs)
            __apply_table_to_options(cfg.Sliders)
            return true
        end
        if next(cfg) ~= nil then
            __apply_table_to_options(cfg)
            return true
        end
        return false
    end

    local path = folder.."/"..AUTOSAVE..".lua"
    local function __count_keys(t)
    local n=0; for _ in pairs(t or {}) do n=n+1 end; return n
end

task.defer(function()
    local used_runtime = false
    local runtime_cfg = rawget(getgenv(), "Config")

    -- 1) Runtime trước
    if type(runtime_cfg) == "table" and __count_keys(runtime_cfg) > 0 then
        used_runtime = __apply_runtime_config(runtime_cfg)
        if used_runtime then
            print(("[AutoSaveGrouped] Applied RUNTIME config (%d top-level keys)."):format(__count_keys(runtime_cfg)))
        end
    end

    -- 2) File nếu chưa dùng runtime và không bị IgnoreFile
    if not used_runtime and not getgenv().ASG_IgnoreFile then
        if isfile(path) then
            print("[AutoSaveGrouped] Loading file:", path)
            -- tách 2 bước để bắt lỗi chi tiết
            local ok_load, chunk_or_err = pcall(loadfile, path)
            if not ok_load or type(chunk_or_err) ~= "function" then
                warn("[AutoSaveGrouped] loadfile() failed: ", tostring(chunk_or_err))
            else
                local ok_run, err_run = pcall(chunk_or_err)
                if not ok_run then
                    warn("[AutoSaveGrouped] running autosave.lua failed: ", tostring(err_run))
                end
            end

            local cfg_after = rawget(getgenv(), "Config")
            if type(cfg_after) == "table" and __count_keys(cfg_after) > 0 then
                __apply_runtime_config(cfg_after)
                print(("[AutoSaveGrouped] Applied FILE config (%d top-level keys)."):format(__count_keys(cfg_after)))
            else
                warn("[AutoSaveGrouped] File loaded but Config is nil/empty.")
            end
        else
            warn("[AutoSaveGrouped] autosave.lua not found at path: ", path)
        end
    end

    -- 3) Sau khi áp xong mới autosave lại để ghi ổn định
    if type(autosave) == "function" then
        task.delay(0.05, function() pcall(autosave) end)
    end
end)
end
