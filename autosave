-- SaveManager (FLAT autosave, safe-patched: no sections, nil-safe, exploit-friendly)
-- L∆∞u/N·∫°p theo t·ª´ng option (Toggle/Dropdown/Input/Slider/Keybind/Colorpicker)
-- File l∆∞u: .lua (return {...})

local httpService = game:GetService("HttpService")

-- polyfills / helpers ---------------------------------------------------------
local function table_clone(src)
    if typeof(table.clone) == "function" then
        return table.clone(src)
    end
    local t = {}
    for k,v in pairs(src) do
        if type(v) == "table" then
            local sub = {}; for k2,v2 in pairs(v) do sub[k2]=v2 end
            t[k] = sub
        else
            t[k] = v
        end
    end
    return t
end

local function color3_from_hex(hex)
    if typeof(Color3.fromHex) == "function" then
        return Color3.fromHex(hex)
    end
    hex = tostring(hex or ""):gsub("^#","")
    if #hex ~= 6 then return Color3.new(1,1,1) end
    local r = tonumber(hex:sub(1,2),16)
    local g = tonumber(hex:sub(3,4),16)
    local b = tonumber(hex:sub(5,6),16)
    return Color3.fromRGB(r,g,b)
end

local function color3_to_hex(c)
    return string.format("#%02X%02X%02X", c.R*255, c.G*255, c.B*255)
end

-- core -----------------------------------------------------------------------
local SaveManager = {}
SaveManager.Folder = "FluentScriptHub"
SaveManager.File   = "autosave.lua"
SaveManager.Ignore = {}
SaveManager.Options = {}
SaveManager.Library = nil
SaveManager._loading = false
SaveManager._suppressSave = false

-- ‚öôÔ∏è ch·∫∑n ghi trong c√°c tr·∫°ng th√°i ƒë√≥ng ho·∫∑c ƒëang load
local function isBlocked(self)
    return self._suppressSave or self._loading or getgenv().__IFACE_CLOSING
end

-- ‚öôÔ∏è L∆∞u ra file
function SaveManager:Save()
    if isBlocked(self) then return end
    local tbl = {}
    for name, option in pairs(self.Options) do
        local val = option.Value
        if typeof(val) == "Color3" then
            tbl[name] = color3_to_hex(val)
        else
            tbl[name] = val
        end
    end
    local content = "return " .. httpService:JSONEncode(tbl)
    local path = self.Folder .. "/" .. self.File
    writefile(path, content)
end

-- ‚öôÔ∏è N·∫°p t·ª´ file
function SaveManager:Load()
    local path = self.Folder .. "/" .. self.File
    if not isfile(path) then return end
    local src = readfile(path)
    local ok, data = pcall(function() return loadstring(src)() end)
    if not ok or type(data) ~= "table" then return end

    self._loading = true
    for name, val in pairs(data) do
        local opt = self.Options[name]
        if opt then
            if typeof(opt.Value) == "Color3" then
                pcall(function() opt:SetValue(color3_from_hex(val)) end)
            else
                pcall(function() opt:SetValue(val) end)
            end
        end
    end
    self._loading = false
end

-- ‚öôÔ∏è reset + save fallback
function SaveManager:ResetAll()
    for name, opt in pairs(self.Options) do
        if typeof(opt.Value) == "boolean" then
            pcall(function() opt:SetValue(false) end)
        end
    end
end

-- ===================== PATCH 1: AUTO STOP LOOP ON GUI CLOSE =====================
local function _setVal(opt, v)
    if type(opt) == "table" and type(rawget(opt, "SetValue")) == "function" then
        local ok = pcall(function() opt:SetValue(v) end)
        if ok then return end
    end
    if type(opt) == "table" and rawget(opt, "Value") ~= nil then
        pcall(function() opt.Value = v end)
    end
end

local function _resetAllToggles_NoSave_Fire(self)
    local lib = self.Library
    if not lib then return end

    local buckets = {}
    if type(lib.Flags) == "table" then table.insert(buckets, lib.Flags) end
    if type(lib.Options) == "table" then table.insert(buckets, lib.Options) end

    for _, bag in ipairs(buckets) do
        for key, opt in pairs(bag) do
            if self.Ignore and self.Ignore[key] then
                -- skip
            else
                local ok, val = pcall(function() return rawget(opt, "Value") end)
                if ok and type(val) == "boolean" and val == true then
                    pcall(function() _setVal(opt, false) end)
                end
            end
        end
    end
end

function SaveManager:_bindGuiCloseWatch()
    if not (self.Library and self.Library.GUI) then return end
    if self._guiBound then return end
    self._guiBound = true

    local gui = self.Library.GUI
    local function _onClosing()
        getgenv().__IFACE_CLOSING = true
        self._suppressSave = true
        _resetAllToggles_NoSave_Fire(self)
        task.defer(function()
            self._suppressSave = false
            getgenv().__IFACE_CLOSING = false
        end)
    end

    pcall(function()
        if gui.Destroying then gui.Destroying:Connect(_onClosing) end
    end)
    gui.AncestryChanged:Connect(function(_, newParent)
        if newParent == nil then _onClosing() end
    end)
end
-- ===================== END PATCH 1 =====================
function SaveManager:SetFolder(path)
    -- path: v√≠ d·ª• "FluentScriptHub/specific-game"
    self.Folder = tostring(path or "FluentScriptHub")

    -- T·∫°o folder n·∫øu ch∆∞a t·ªìn t·∫°i
    if not isfolder(self.Folder) then
        makefolder(self.Folder)
    end
end
-- ‚öôÔ∏è G√°n Library v√† Options
function SaveManager:SetLibrary(lib)
    self.Library = lib
    self.Options = (self.Library and (self.Library.Flags or self.Library.Options)) or {}
    -- üëá Th√™m watcher khi GUI ƒë√≥ng
    self:_bindGuiCloseWatch()
end

-- ‚öôÔ∏è Ghi ƒë√® SaveManager global
getgenv().SaveManager = SaveManager
return SaveManager
