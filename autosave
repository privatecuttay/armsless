return function(SaveManager)
    local AUTOSAVE = "autosave"
    local saving   = false
    local folder   = SaveManager.Folder .. "/settings"

    local function collect_raw()
        local raw = {}
        for idx,opt in pairs(SaveManager.Options) do
            if SaveManager.Parser[opt.Type] and not SaveManager.Ignore[idx] then
                local ok,obj = pcall(SaveManager.Parser[opt.Type].Save, idx, opt)
                if ok and obj then raw[obj.idx or idx] = obj end
            end
        end
        return raw
    end

    local function type_order(t)
        if t == "Toggle"   then return 1 end
        if t == "Dropdown" then return 2 end
        if t == "Input"    then return 3 end
        if t == "Slider"   then return 4 end
        return 99
    end

    local function esc(s)
        s = tostring(s or ""):gsub("\\","\\\\"):gsub('"','\\"')
        return s
    end

    -- Save all controls (Lua table style)
    local function writeLuaConfig()
        local raw = collect_raw()
        local sorted = {}
        for k,_ in pairs(raw) do table.insert(sorted, k) end
        table.sort(sorted, function(a,b)
            local ta,tb = raw[a].type, raw[b].type
            local ra,rb = type_order(ta), type_order(tb)
            if ra == rb then return tostring(a) < tostring(b) end
            return ra < rb
        end)

        local lines = { "getgenv().Config = {" }
        for _,key in ipairs(sorted) do
            local obj = raw[key]
            local valStr = ""

            if obj.type == "Toggle" then
                valStr = tostring(obj.value == true)
            elseif obj.type == "Input" then
                valStr = string.format('"%s"', esc(obj.text))
            elseif obj.type == "Dropdown" then
                if obj.mutli then
                    local arr = {}
                    for _,v in ipairs(obj.value or {}) do
                        table.insert(arr, string.format('"%s"', esc(v)))
                    end
                    valStr = "{ " .. table.concat(arr, ", ") .. " }"
                else
                    valStr = string.format('"%s"', esc(obj.value or ""))
                end
            elseif obj.type == "Slider" then
                valStr = tostring(obj.value or 0)
            else
                valStr = string.format('"%s"', esc(obj.value or obj.text or ""))
            end

            table.insert(lines, string.format("    %s = %s,", key, valStr))
        end
        table.insert(lines, "}")

        if not isfolder(SaveManager.Folder) then makefolder(SaveManager.Folder) end
        if not isfolder(folder) then makefolder(folder) end
        local path = folder .. "/" .. AUTOSAVE .. ".lua"
        writefile(path, table.concat(lines, "\n"))

        if not isfile(folder .. "/autoload.txt") then
            writefile(folder .. "/autoload.txt", AUTOSAVE)
        end
    end

    -- debounce autosave
    local function autosave()
        if saving then return end
        saving = true
        task.delay(0.25, function()
            pcall(writeLuaConfig)
            saving = false
        end)
    end

    -- Hook changes
    local function hook(opt)
        if type(opt) ~= "table" then return end
        if type(opt.OnChanged) == "function" then
            pcall(function() opt:OnChanged(autosave) end)
        end
        if type(opt.SetValue) == "function" then
            local o = opt.SetValue
            opt.SetValue = function(self, ...)
                local r = o(self, ...)
                autosave()
                return r
            end
        end
    end

    for _,opt in pairs(SaveManager.Options) do hook(opt) end
    do
        local opts = SaveManager.Options
        local mt = getmetatable(opts) or {}
        local old = mt.__newindex
        mt.__newindex = function(t, k, v)
            rawset(t, k, v)
            hook(v)
            if type(old) == "function" then pcall(old, t, k, v) end
        end
        setmetatable(opts, mt)
    end

    -- save 1 lần lúc start
    autosave()

    -- restore lại từ autosave.lua
    local path = folder .. "/" .. AUTOSAVE .. ".lua"
    if isfile(path) then
        local ok, _ = pcall(function() loadfile(path)() end)
        if ok and getgenv().Config then
            task.defer(function()
                for k,v in pairs(getgenv().Config) do
                    local opt = SaveManager.Options[k]
                    if opt then
                        if opt.Type == "Toggle" then
                            pcall(function() opt:SetValue(v == true) end)
                        elseif opt.Type == "Input" then
                            pcall(function() opt:SetValue(tostring(v or "")) end)
                        elseif opt.Type == "Dropdown" then
                            pcall(function()
                                if opt.Multi then
                                    opt:SetValue(type(v)=="table" and v or {})
                                else
                                    opt:SetValue(v ~= nil and v or "")
                                end
                            end)
                        elseif opt.Type == "Slider" then
                            pcall(function() opt:SetValue(tonumber(v) or 0) end)
                        end
                    end
                end
            end)
        else
            warn("[AutoSave] Không thể load autosave.lua")
        end
    end
end
