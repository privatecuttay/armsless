-- SaveManager.lua abc
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "FluentScriptHub/specific-game"
    SaveManager.FileName = "autosave.lua"

    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Ignore  = {}
    SaveManager._suppressSave = false
    SaveManager._ifaceBlock   = 0
    SaveManager._debug        = false

    -- ========= utils =========
    local function dbg(...) if SaveManager._debug then print("[SaveManager]", ...) end end
    local function ensureFolder(p) if not isfolder(p) then pcall(makefolder,p) end end
    local function autosavePath() return SaveManager.Folder.."/"..SaveManager.FileName end
    local function ensureFile(path) if not isfile(path) then pcall(writefile, path, "return {}\n") end end

    -- Lua serializer (không dùng JSON, hợp lệ cho loadstring)
    local function serialize(v, indent)
        indent = indent or ""
        local tv = typeof(v)
        if tv=="nil" or tv=="boolean" or tv=="number" then return tostring(v)
        elseif tv=="string" then return string.format("%q", v)
        elseif tv=="table" then
            local nextIndent = indent.."  "
            local parts = {}
            for k,val in pairs(v) do
                local key = (type(k)=="string" and k:match("^[%a_][%w_]*$")) and k or "["..serialize(k,nextIndent).."]"
                parts[#parts+1] = string.format("%s%s = %s", nextIndent, key, serialize(val,nextIndent))
            end
            if #parts==0 then return "{}" end
            return "{\n"..table.concat(parts, ",\n").."\n"..indent.."}"
        else
            return string.format("%q", tostring(v))
        end
    end

    local function read_lua_table(path)
        if not isfile(path) then return {} end
        local ok, src = pcall(readfile, path); if not ok then return {} end
        local fn, e = loadstring(src); if not fn then warn("[SaveManager] parse autosave.lua failed:", e) return {} end
        local ok2, res = pcall(fn); if not ok2 or type(res)~="table" then return {} end
        return res
    end
    local function write_lua_table(path, tbl)
        local ok, err = pcall(writefile, path, "return "..serialize(tbl).."\n")
        if not ok then warn("[SaveManager] write autosave.lua failed:", err) end
    end

    local function isBlocked(self) return (self._suppressSave==true) or ((self._ifaceBlock or 0)>0) end
    local function hasAny(tbl) for _ in pairs(tbl or {}) do return true end return false end
    local function getFlags(self)
        local L = self.Library
        return (L and (L.Flags or L.Options)) or {}
    end

    -- ========= iface block =========
    function SaveManager:_IfaceBlockOn()  self._ifaceBlock = (self._ifaceBlock or 0) + 1 end
    function SaveManager:_IfaceBlockOff() self._ifaceBlock = math.max(0, (self._ifaceBlock or 0) - 1) end

    -- ========= public API =========
    function SaveManager:SetIgnoreIndexes(list)
        self.Ignore = {}
        for _,k in ipairs(list or {}) do self.Ignore[k] = true end
    end
    function SaveManager:SetFolder(folder)
        self.Folder = folder or self.Folder
        ensureFolder(self.Folder)
        ensureFile(autosavePath())
    end
    function SaveManager:SetLibrary(lib)
        self.Library = lib
        self.Options = getFlags(self)
    end

    -- ========= helpers =========
    local function getVal(opt)
        if typeof(opt)~="table" then return nil end
        return rawget(opt,"Value")
    end
    local function setVal(opt, v)
        if typeof(opt)~="table" then return end
        if typeof(opt.SetValue)=="function" then pcall(function() opt:SetValue(v) end)
        else opt.Value = v end
    end

    function SaveManager:_readAll()
        ensureFolder(self.Folder); ensureFile(autosavePath())
        return read_lua_table(autosavePath())
    end
    function SaveManager:_writeAll(tbl)
        ensureFolder(self.Folder); ensureFile(autosavePath())
        write_lua_table(autosavePath(), tbl)
        dbg("wrote file")
    end
    function SaveManager:_writeKey(key, v)
        if isBlocked(self) then return end
        if self.Ignore and self.Ignore[key] then return end
        local t = self:_readAll(); t[key]=v; self:_writeAll(t)
    end

    function SaveManager:_applyAllToOptions()
        local t = self:_readAll()
        local opts = getFlags(self)
        for k,v in pairs(t) do
            if not (self.Ignore and self.Ignore[k]) then
                local o = opts[k]; if o then pcall(setVal, o, v) end
            end
        end
    end

    -- Ghi snapshot nếu có ít nhất 1 option
    function SaveManager:_snapshotAllIfReady()
        if isBlocked(self) then return end
        local opts = getFlags(self)
        if not hasAny(opts) then dbg("skip snapshot: no options yet") return end
        local data = {}
        for k,o in pairs(opts) do
            if not (self.Ignore and self.Ignore[k]) then data[k] = getVal(o) end
        end
        if hasAny(data) then self:_writeAll(data) end
    end

    -- ========= hook + polling =========
    function SaveManager:_HookAutosave()
        -- 1) delta-hook qua OnChanged nếu có
        task.spawn(function()
            while task.wait(0.25) do
                local flags = getFlags(self)
                if type(flags)~="table" or not hasAny(flags) then continue end
                for key, opt in pairs(flags) do
                    if self.Ignore and self.Ignore[key] then continue end
                    if typeof(opt)=="table" and typeof(opt.OnChanged)=="function" and not opt.__as_hooked then
                        opt.__as_hooked = true
                        local old = opt.OnChanged
                        opt.OnChanged = function(...)
                            local ok, err = pcall(old, ...)
                            if not ok then warn("[SaveManager] OnChanged:", err) end
                            if isBlocked(SaveManager) then return end
                            task.defer(function() SaveManager:_writeKey(key, getVal(opt)) end)
                        end
                    end
                end
            end
        end)

        -- 2) polling dự phòng nếu option không có OnChanged
        task.spawn(function()
            local last = {}
            while task.wait(0.5) do
                local flags = getFlags(self)
                if type(flags)~="table" or not hasAny(flags) then continue end
                for key, opt in pairs(flags) do
                    if self.Ignore and self.Ignore[key] then continue end
                    local cur = getVal(opt)
                    if last[key] ~= cur then
                        last[key] = cur
                        if not isBlocked(self) then
                            self:_writeKey(key, cur)
                        end
                    end
                end
            end
        end)
    end

    -- ========= lifecycle =========
    function SaveManager:LoadWithPriority()
        -- Đợi UI tạo xong ít nhất 1 option rồi mới apply/hook/snapshot
        task.spawn(function()
            local deadline = os.clock() + 10
            while os.clock() < deadline and not hasAny(getFlags(self)) do task.wait(0.1) end

            self:_applyAllToOptions()
            self:_HookAutosave()
            self:_snapshotAllIfReady() -- không ghi {} đè file
        end)
    end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
