-- SaveManager.lua
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "FluentScriptHub/specific-game"
    SaveManager.FileName = "autosave.json"
    SaveManager.SettingsFile = "options.json"

    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Settings = {}
    SaveManager.IgnoreTheme = true
    SaveManager.IgnoreIndexes = {}
    SaveManager._suppressSave = false

    local function ensureFolders(self)
        local base = self.Folder
        local paths = {
            base,
            base .. "/settings",
        }
        for _,p in ipairs(paths) do
            if not isfolder(p) then makefolder(p) end
        end
    end

    local function optionsPath(self) return self.Folder .. "/" .. self.FileName end
    local function settingsPath(self) return self.Folder .. "/settings/" .. self.SettingsFile end

    function SaveManager:SetFolder(folder)
        self.Folder = folder
        ensureFolders(self)
    end

    function SaveManager:SetLibrary(lib)
        self.Library = lib
    end

    function SaveManager:IgnoreThemeSettings()
        self.IgnoreTheme = true
    end

    function SaveManager:SetIgnoreIndexes(t)
        self.IgnoreIndexes = t or {}
    end

    -- no-op for compatibility with old scripts that call this
    function SaveManager:_HookAllOptions()
        if not self.Library or typeof(self.Library.Flags) ~= "table" then return end
        for key, flag in pairs(self.Library.Flags) do
            if typeof(flag)=="table" and typeof(flag.OnChanged)=="function" then
                flag:OnChanged(function()
                    if self._suppressSave then return end
                    local val = rawget(flag,"Value")
                    self.Options[key] = val
                    self:Save()
                end)
            end
        end
    end

    function SaveManager:BuildConfigSection(tab)
        if not tab then return end
        local section = tab:AddSection("Config")
        section:AddButton({Title = "Save Config", Callback = function() self:Save() end})
        section:AddButton({Title = "Load Config", Callback = function() self:Load() end})
    end

    function SaveManager:Save()
        if self._suppressSave then return end
        ensureFolders(self)
        local data = {}

        if self.Library and typeof(self.Library.Flags)=="table" then
            for key, flag in pairs(self.Library.Flags) do
                if self.IgnoreIndexes[key] ~= true then
                    local v = rawget(flag, "Value")
                    if v ~= nil then data[key] = v end
                end
            end
        end

        self.Options = data
        writefile(optionsPath(self), HttpService:JSONEncode(data))
    end

    function SaveManager:Load()
        ensureFolders(self)
        local p = optionsPath(self)
        if isfile(p) then
            local ok, decoded = pcall(function()
                return HttpService:JSONDecode(readfile(p))
            end)
            if ok and type(decoded)=="table" then
                self.Options = decoded
                if self.Library and typeof(self.Library.Flags)=="table" then
                    for key, val in pairs(decoded) do
                        local flag = self.Library.Flags[key]
                        if flag and typeof(flag.SetValue)=="function" then
                            pcall(function() flag:SetValue(val) end)
                        elseif flag then
                            flag.Value = val
                        end
                    end
                end
            end
        end
    end

    function SaveManager:SaveSettings()
        if self._suppressSave then return end
        ensureFolders(self)
        writefile(settingsPath(self), HttpService:JSONEncode(self.Settings))
    end

    function SaveManager:LoadSettings()
        ensureFolders(self)
        local p = settingsPath(self)
        if isfile(p) then
            local ok, decoded = pcall(function()
                return HttpService:JSONDecode(readfile(p))
            end)
            if ok and type(decoded)=="table" then
                self.Settings = decoded
            end
        end
    end

    -- compatibility helpers some scripts call:
    function SaveManager:LoadWithPriority(_autoload)
        self:LoadSettings()
        self:Load()
        self:_HookAllOptions()
    end

    function SaveManager:LoadAutoloadConfig()
        -- kept for compatibility; no-op
    end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
