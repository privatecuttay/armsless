-- üü¶ SaveManager.lua 1
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "FluentScriptHub/specific-game"
    SaveManager.FileName = "autosave.lua"
    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Ignore = {}
    SaveManager._suppressSave = false

    ---------------------------------------------------------------------
    -- ‚öôÔ∏è Helpers
    local function ensureFolder(path)
        if not isfolder(path) then
            local ok, err = pcall(makefolder, path)
            if not ok then warn("[SaveManager] makefolder failed:", err) end
        end
    end

    local function autosavePath()
        return SaveManager.Folder .. "/" .. SaveManager.FileName
    end

    local function ensureFile(path)
        if not isfile(path) then
            pcall(writefile, path, "return {}\n")
        end
    end

    local function serialize(val, indent)
        indent = indent or ""
        local t = typeof(val)
        if t == "nil" then return "nil"
        elseif t == "boolean" or t == "number" then return tostring(val)
        elseif t == "string" then return string.format("%q", val)
        elseif t == "table" then
            local nextIndent = indent .. "  "
            local out = "{\n"
            for k,v in pairs(val) do
                local key
                if type(k) == "string" and k:match("^[%a_][%w_]*$") then
                    key = k
                else
                    key = "[" .. serialize(k, nextIndent) .. "]"
                end
                out ..= string.format("%s  %s = %s,\n", indent, key, serialize(v, nextIndent))
            end
            return out .. indent .. "}"
        end
        return string.format("%q", tostring(val))
    end

    local function read_lua_table(path)
        if not isfile(path) then return {} end
        local ok, src = pcall(readfile, path)
        if not ok then return {} end
        local fn, err = loadstring(src)
        if not fn then warn("[SaveManager] parse autosave.lua failed:", err) return {} end
        local ok2, res = pcall(fn)
        if not ok2 or type(res) ~= "table" then return {} end
        return res
    end

    local function write_lua_table(path, tbl)
        local ok, err = pcall(writefile, path, "return " .. serialize(tbl) .. "\n")
        if not ok then warn("[SaveManager] write autosave.lua failed:", err) end
    end

    local function isBlocked(self)
        return self._suppressSave or getgenv().__IFACE_CLOSING
    end

    ---------------------------------------------------------------------
    -- üß© Public API
    function SaveManager:SetIgnoreIndexes(list)
        self.Ignore = {}
        for _,k in ipairs(list or {}) do self.Ignore[k] = true end
    end

    function SaveManager:SetFolder(folder)
        self.Folder = folder or self.Folder
        ensureFolder(self.Folder)
        ensureFile(autosavePath())
    end

    function SaveManager:SetLibrary(lib)
        self.Library = lib
        self.Options = (lib and (lib.Flags or lib.Options)) or {}
    end

    ---------------------------------------------------------------------
    -- ‚öôÔ∏è Core save/load
    local function getValue(opt)
        if typeof(opt) ~= "table" then return nil end
        return rawget(opt, "Value")
    end

    local function setValue(opt, v)
        if typeof(opt) ~= "table" then return end
        if typeof(opt.SetValue) == "function" then
            pcall(function() opt:SetValue(v) end)
        else
            opt.Value = v
        end
    end

    function SaveManager:_readAll()
        ensureFolder(self.Folder)
        ensureFile(autosavePath())
        return read_lua_table(autosavePath())
    end

    function SaveManager:_writeAll(tbl)
        ensureFolder(self.Folder)
        ensureFile(autosavePath())
        write_lua_table(autosavePath(), tbl)
    end

    function SaveManager:_writeKey(key, val)
        if isBlocked(self) then return end
        if self.Ignore and self.Ignore[key] then return end
        local tbl = self:_readAll()
        tbl[key] = val
        self:_writeAll(tbl)
    end

    ---------------------------------------------------------------------
    -- üîÅ Hook autosave (OnChanged watcher)
    function SaveManager:_HookAutosave()
        task.spawn(function()
            while task.wait(0.25) do
                local flags = self.Library and (self.Library.Flags or self.Library.Options)
                if type(flags) ~= "table" then continue end
                for key, opt in pairs(flags) do
                    if self.Ignore and self.Ignore[key] then continue end
                    if typeof(opt) == "table" and typeof(opt.OnChanged) == "function" and not opt._hooked then
                        opt._hooked = true
                        local old = opt.OnChanged
                        opt.OnChanged = function(...)
                            local ok, err = pcall(old, ...)
                            if not ok then warn("[SaveManager] OnChanged error:", err) end
                            if isBlocked(SaveManager) then return end
                            task.defer(function()
                                SaveManager:_writeKey(key, getValue(opt))
                            end)
                        end
                    end
                end
            end
        end)
    end

    ---------------------------------------------------------------------
    -- üöÄ Load autosave + apply UI
    function SaveManager:LoadWithPriority()
        local tbl = self:_readAll()
        local opts = (self.Library and (self.Library.Flags or self.Library.Options)) or {}

        -- Apply saved values to UI without triggering double saves
        self._suppressSave = true
        for key, val in pairs(tbl) do
            if not (self.Ignore and self.Ignore[key]) then
                local opt = opts[key]
                if opt then pcall(setValue, opt, val) end
            end
        end
        task.delay(0.2, function()
            self._suppressSave = false
        end)

        self:_HookAutosave()
    end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
