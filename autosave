return function(SaveManager)
    local AUTOSAVE = "autosave"
    local saving   = false
    local folder   = SaveManager.Folder .. "/settings"

    -- Thu thập option -> obj từ SaveManager.Parser.Save
    local function collect_raw()
        local raw = {}
        for idx,opt in pairs(SaveManager.Options) do
            if SaveManager.Parser[opt.Type] and not SaveManager.Ignore[idx] then
                local ok,obj = pcall(SaveManager.Parser[opt.Type].Save, idx, opt)
                if ok and obj then raw[obj.idx or idx] = obj end
            end
        end
        return raw
    end

    local function esc(s)
        s = tostring(s or ""):gsub("\\","\\\\"):gsub('"','\\"')
        return s
    end

    -- ===== Ghi file nhóm theo loại =====
    local function writeLuaConfig()
        local raw = collect_raw()
        local groups = { Toggles = {}, Dropdowns = {}, Inputs = {}, Sliders = {} }

        for k,obj in pairs(raw) do
            if obj.type == "Toggle" then
                groups.Toggles[k] = obj.value == true
            elseif obj.type == "Input" then
                groups.Inputs[k] = tostring(obj.text or "")
            elseif obj.type == "Dropdown" then
                if obj.mutli then
                    groups.Dropdowns[k] = obj.value or {}
                else
                    groups.Dropdowns[k] = tostring(obj.value or "")
                end
            elseif obj.type == "Slider" then
                groups.Sliders[k] = tonumber(obj.value or 0)
            end
        end

        local function serialize(tbl, indent)
            indent = indent or "    "
            local lines = {"{"}
            -- sắp xếp khóa để ổn định
            local keys = {}
            for k,_ in pairs(tbl) do keys[#keys+1] = k end
            table.sort(keys, function(a,b) return tostring(a) < tostring(b) end)

            for _,k in ipairs(keys) do
                local v   = tbl[k]
                local key = tostring(k)
                local val
                if type(v) == "string" then
                    val = string.format('"%s"', esc(v))
                elseif type(v) == "table" then
                    -- table con (multi dropdown)
                    local sub = {"{"}
                    -- nếu là array thuần -> in mảng; nếu là map -> in map
                    local is_array = (#v > 0)
                    if is_array then
                        for i=1,#v do
                            sub[#sub+1] = string.format("%s    \"%s\",", indent, esc(v[i]))
                        end
                    else
                        local sk = {}
                        for kk,_ in pairs(v) do sk[#sk+1]=kk end
                        table.sort(sk, function(a,b) return tostring(a) < tostring(b) end)
                        for _,kk in ipairs(sk) do
                            sub[#sub+1] = string.format("%s    [\"%s\"] = %s,", indent, esc(kk), tostring(v[kk] and true or false))
                        end
                    end
                    sub[#sub+1] = indent.."}"
                    val = table.concat(sub, "\n")
                else
                    val = tostring(v)
                end
                lines[#lines+1] = string.format("%s%s = %s,", indent, key, val)
            end
            lines[#lines+1] = (indent:sub(1, -5) or "").."}"
            return table.concat(lines, "\n")
        end

        local out = {"getgenv().Config = {"}
        out[#out+1] = "    Toggles = "..serialize(groups.Toggles, "        ")..","
        out[#out+1] = "    Dropdowns = "..serialize(groups.Dropdowns, "        ")..","
        out[#out+1] = "    Inputs = "..serialize(groups.Inputs, "        ")..","
        out[#out+1] = "    Sliders = "..serialize(groups.Sliders, "        ")..","
        out[#out+1] = "}"

        if not isfolder(SaveManager.Folder) then makefolder(SaveManager.Folder) end
        if not isfolder(folder) then makefolder(folder) end
        local path = folder.."/"..AUTOSAVE..".lua"
        writefile(path, table.concat(out, "\n"))

        -- đặt autoload trỏ đến autosave
        local autoload = folder.."/autoload.txt"
        if not isfile(autoload) then writefile(autoload, AUTOSAVE) end
    end

    -- debounce autosave
    local function autosave()
        if saving then return end
        saving = true
        task.delay(0.25, function()
            pcall(writeLuaConfig)
            saving = false
        end)
    end

    -- hook mọi option để autosave khi đổi
    local function hook(opt)
        if type(opt) ~= "table" then return end
        if type(opt.OnChanged) == "function" then pcall(function() opt:OnChanged(autosave) end) end
        if type(opt.SetValue) == "function" then
            local o = opt.SetValue
            opt.SetValue = function(self, ...)
                local r = o(self, ...)
                autosave()
                return r
            end
        end
    end
    for _,opt in pairs(SaveManager.Options) do hook(opt) end
    do
        local opts = SaveManager.Options
        local mt = getmetatable(opts) or {}
        local old = mt.__newindex
        mt.__newindex = function(t, k, v)
            rawset(t, k, v); hook(v)
            if type(old) == "function" then pcall(old, t, k, v) end
        end
        setmetatable(opts, mt)
    end

    -- lưu lần đầu
    autosave()

    -- ===== Khôi phục từ autosave.lua (đọc theo nhóm) =====
    local path = folder.."/"..AUTOSAVE..".lua"
    if isfile(path) then
        local ok,_ = pcall(function() loadfile(path)() end)
        if ok and getgenv().Config then
            task.defer(function()
                local cfg = getgenv().Config
                local function apply(tbl)
                    for key,val in pairs(tbl or {}) do
                        local opt = SaveManager.Options[key]
                        if opt then
                            if opt.Type == "Toggle" then
                                pcall(function() opt:SetValue(val == true) end)
                            elseif opt.Type == "Input" then
                                pcall(function() opt:SetValue(tostring(val or "")) end)
                            elseif opt.Type == "Dropdown" then
                                pcall(function()
                                    if opt.Multi then
                                        opt:SetValue(type(val)=="table" and val or {})
                                    else
                                        opt:SetValue(val ~= nil and val or "")
                                    end
                                end)
                            elseif opt.Type == "Slider" then
                                pcall(function() opt:SetValue(tonumber(val) or 0) end)
                            end
                        end
                    end
                end
                apply(cfg.Toggles)
                apply(cfg.Dropdowns)
                apply(cfg.Inputs)
                apply(cfg.Sliders)
            end)
        else
            warn("[AutoSaveGrouped] Không thể load autosave.lua")
        end
    end
end
