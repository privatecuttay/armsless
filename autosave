-- SaveManager.lua (stable autosave: no empty overwrite, lua-serializer, ifaceBlock)
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "FluentScriptHub/specific-game"
    SaveManager.FileName = "autosave.lua"

    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Ignore  = {}
    SaveManager._suppressSave = false
    SaveManager._ifaceBlock   = 0
    SaveManager._debug        = false

    -- ===== utils =====
    local function dbg(...) if SaveManager._debug then print("[SaveManager]", ...) end end

    local function ensureFolder(p) if not isfolder(p) then pcall(makefolder,p) end end
    local function autosavePath() return SaveManager.Folder.."/"..SaveManager.FileName end
    local function ensureFile(path)
        if not isfile(path) then pcall(writefile, path, "return {}\n") end
    end

    -- Lua table serializer (không dùng JSON)
    local function serialize(val, indent)
        indent = indent or ""
        local t = typeof(val)
        if t=="nil" then return "nil"
        elseif t=="boolean" or t=="number" then return tostring(val)
        elseif t=="string" then return string.format("%q", val)
        elseif t=="table" then
            local nextIndent = indent .. "  "
            local parts = {}
            for k,v in pairs(val) do
                local key
                if type(k)=="string" and k:match("^[%a_][%w_]*$") then
                    key = k
                else
                    key = "["..serialize(k, nextIndent).."]"
                end
                parts[#parts+1] = string.format("%s%s = %s", nextIndent, key, serialize(v, nextIndent))
            end
            if #parts==0 then return "{}" end
            return "{\n"..table.concat(parts, ",\n").."\n"..indent.."}"
        else
            return string.format("%q", tostring(val))
        end
    end

    local function read_lua_table(path)
        if not isfile(path) then return {} end
        local ok, src = pcall(readfile, path); if not ok then return {} end
        local fn, e = loadstring(src); if not fn then warn("[SaveManager] parse autosave.lua failed:", e) return {} end
        local ok2, res = pcall(fn); if not ok2 or type(res)~="table" then return {} end
        return res
    end

    local function write_lua_table(path, tbl)
        local ok, err = pcall(writefile, path, "return "..serialize(tbl).."\n")
        if not ok then warn("[SaveManager] write autosave.lua failed:", err) end
    end

    local function isBlocked(self) return (self._suppressSave==true) or ((self._ifaceBlock or 0)>0) end
    local function hasAny(tbl) for _ in pairs(tbl or {}) do return true end return false end

    -- ===== iface block =====
    function SaveManager:_IfaceBlockOn()  self._ifaceBlock = (self._ifaceBlock or 0) + 1 end
    function SaveManager:_IfaceBlockOff() self._ifaceBlock = math.max(0, (self._ifaceBlock or 0) - 1) end

    -- ===== public compat =====
    function SaveManager:SetIgnoreIndexes(list)
        self.Ignore = self.Ignore or {}
        for _,k in ipairs(list or {}) do self.Ignore[k] = true end
    end
    function SaveManager:SetFolder(folder)
        self.Folder = folder or self.Folder
        ensureFolder(self.Folder)
        ensureFolder(self.Folder.."/settings")
        ensureFile(autosavePath())
    end
    function SaveManager:SetLibrary(lib)
        self.Library = lib
        -- Một số Fluent dùng Flags, số khác dùng Options
        self.Options = (lib and (lib.Flags or lib.Options)) or {}
    end

    -- ===== helpers value =====
    local function getVal(opt)
        if typeof(opt)~="table" then return nil end
        return rawget(opt,"Value")
    end
    local function setVal(opt, v)
        if typeof(opt)~="table" then return end
        if typeof(opt.SetValue)=="function" then pcall(function() opt:SetValue(v) end)
        else opt.Value = v end
    end

    -- ===== core io =====
    function SaveManager:_readAll()
        ensureFolder(self.Folder); ensureFile(autosavePath())
        return read_lua_table(autosavePath())
    end
    function SaveManager:_writeAll(tbl)
        ensureFolder(self.Folder); ensureFile(autosavePath())
        write_lua_table(autosavePath(), tbl)
        dbg("autosave wrote", autosavePath())
    end
    function SaveManager:_writeKey(k, v)
        if isBlocked(self) then return end
        if self.Ignore and self.Ignore[k] then return end
        local t = self:_readAll(); t[k]=v; self:_writeAll(t)
    end

    function SaveManager:_applyAllToOptions()
        local t = self:_readAll()
        local opts = self.Options or {}
        for k,v in pairs(t) do
            if not (self.Ignore and self.Ignore[k]) then
                local o = opts[k]; if o then pcall(setVal, o, v) end
            end
        end
    end

    function SaveManager:_snapshotAll()
        if isBlocked(self) then return end
        -- ⚠️ KHÔNG snapshot nếu chưa có option nào, tránh ghi {} đè file
        if not hasAny(self.Options) then dbg("skip snapshot (no options yet)"); return end
        local data = {}
        for k,o in pairs(self.Options) do
            if not (self.Ignore and self.Ignore[k]) then data[k]=getVal(o) end
        end
        self:_writeAll(data)
    end

    -- ===== hooks (delta-write per key) =====
    function SaveManager:_HookAutosave()
        task.spawn(function()
            while task.wait(0.2) do
                local flags = self.Library and (self.Library.Flags or self.Library.Options)
                if type(flags)~="table" then continue end
                for key, opt in pairs(flags) do
                    if self.Ignore and self.Ignore[key] then continue end
                    if typeof(opt)=="table" and typeof(opt.OnChanged)=="function" and not opt.__as_hooked then
                        opt.__as_hooked = true
                        local old = opt.OnChanged
                        opt.OnChanged = function(...)
                            local ok, err = pcall(old, ...)
                            if not ok then warn("[SaveManager] OnChanged:", err) end
                            if isBlocked(SaveManager) then return end
                            task.defer(function() SaveManager:_writeKey(key, getVal(opt)) end)
                        end
                    end
                end
            end
        end)
    end

    -- ===== lifecycle =====
    function SaveManager:LoadWithPriority()
        -- 1) KHÔI PHỤC từ file (nếu có)
        self:_applyAllToOptions()
        -- 2) GẮN HOOK delta
        self:_HookAutosave()
        -- 3) KHÔNG snapshot lập tức (tránh ghi {} đè file khi GUI chưa build xong)
        --    → chỉ khi user thay đổi, delta-write mới ghi.
        -- Nếu muốn ép ghi sau khi GUI build xong, tự gọi SaveManager:_snapshotAll() **khi đã có options**.
    end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
