-- SaveManager.lua 321
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "FluentScriptHub/specific-game"
    SaveManager.FileName = "autosave.lua"
    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager._suppressSave = false
    SaveManager._ifaceBlock = 0

    ---------------------------------------------------------------------
    -- ðŸ§± Utility
    local function ensureFolder(path)
        if not isfolder(path) then
            local ok, err = pcall(makefolder, path)
            if not ok then warn("[SaveManager] makefolder failed:", err) end
        end
    end

    local function ensureFile(path)
        if not isfile(path) then
            local ok, err = pcall(writefile, path, "return {}")
            if not ok then warn("[SaveManager] init autosave.lua failed:", err) end
        end
    end

    local function autosavePath()
        return SaveManager.Folder .. "/" .. SaveManager.FileName
    end

    local function read_lua_table(path)
        if not isfile(path) then return {} end
        local src = readfile(path)
        local f, err = loadstring(src)
        if not f then warn("[SaveManager] parse autosave.lua failed:", err) return {} end
        local ok, res = pcall(f)
        if not ok or type(res) ~= "table" then return {} end
        return res
    end

    local function write_lua_table(path, tbl)
        local dumped = "return " .. HttpService:JSONEncode(tbl):gsub('"%[','['):gsub('%]"',']')
        local ok, err = pcall(writefile, path, dumped)
        if not ok then warn("[SaveManager] write autosave.lua failed:", err) end
    end

    ---------------------------------------------------------------------
    -- ðŸš« Interface block
    function SaveManager:_IfaceBlockOn()
        self._ifaceBlock = (self._ifaceBlock or 0) + 1
    end
    function SaveManager:_IfaceBlockOff()
        self._ifaceBlock = math.max(0, (self._ifaceBlock or 0) - 1)
    end
    local function _isBlocked(self)
        return (self._suppressSave == true) or ((self._ifaceBlock or 0) > 0)
    end

    ---------------------------------------------------------------------
    -- ðŸ”§ Helpers
    local function getOptionValue(opt)
        if typeof(opt) ~= "table" then return nil end
        return rawget(opt, "Value")
    end

    local function setOptionValue(opt, val)
        if typeof(opt) ~= "table" then return end
        if typeof(opt.SetValue) == "function" then
            pcall(function() opt:SetValue(val) end)
        else
            opt.Value = val
        end
    end

    local function readAutosave()
        ensureFolder(SaveManager.Folder)
        ensureFile(autosavePath())
        return read_lua_table(autosavePath())
    end

    local function writeAutosave(tbl)
        ensureFolder(SaveManager.Folder)
        ensureFile(autosavePath())
        write_lua_table(autosavePath(), tbl)
    end

    ---------------------------------------------------------------------
    -- ðŸ’¾ Core write
    function SaveManager:_WriteAutosaveKey(key, value)
        if _isBlocked(self) then return end
        local tbl = readAutosave()
        tbl[key] = value
        writeAutosave(tbl)
    end

    function SaveManager:_SaveCurrentOptionsToAutosave()
        if _isBlocked(self) then return end
        local data = {}
        for key, opt in pairs(self.Options or {}) do
            data[key] = getOptionValue(opt)
        end
        writeAutosave(data)
    end

    function SaveManager:_ApplyAutosaveToCurrentOptions()
        local tbl = readAutosave()
        for key, val in pairs(tbl) do
            local opt = self.Options[key]
            if opt then pcall(setOptionValue, opt, val) end
        end
    end

    ---------------------------------------------------------------------
    -- ðŸ§  Hooks
    function SaveManager:_HookAutosave()
        task.spawn(function()
            while task.wait(0.25) do
                if not self.Library or type(self.Library.Flags) ~= "table" then continue end
                for key, opt in pairs(self.Library.Flags) do
                    if typeof(opt.OnChanged) == "function" and not opt._hooked then
                        opt._hooked = true
                        local old = opt.OnChanged
                        opt.OnChanged = function(...)
                            local ok, err = pcall(old, ...)
                            if not ok then warn("[SaveManager] OnChanged err:", err) end
                            if _isBlocked(SaveManager) then return end
                            task.defer(function()
                                SaveManager:_WriteAutosaveKey(key, getOptionValue(opt))
                            end)
                        end
                    end
                end
            end
        end)
    end

    ---------------------------------------------------------------------
    -- ðŸ§© Public API
    function SaveManager:SetFolder(folder)
        self.Folder = folder
        ensureFolder(self.Folder)
        ensureFile(autosavePath())
    end

    function SaveManager:SetLibrary(lib)
        self.Library = lib
        self.Options = lib and lib.Flags or {}
    end

    function SaveManager:LoadWithPriority()
        self:_ApplyAutosaveToCurrentOptions()
        self:_HookAutosave()
        self:_SaveCurrentOptionsToAutosave()
    end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
