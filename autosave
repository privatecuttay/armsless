-- SaveManager.lua (tự động lưu vào autosave.lua, an toàn khi GUI bị xóa)
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder       = "FluentScriptHub/specific-game"
    SaveManager.FileName     = "autosave.lua"
    SaveManager.SettingsFile = "options.json"

    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Settings = {}
    SaveManager.IgnoreIndexes = {}
    SaveManager._suppressSave = false
    SaveManager._debug = false

    -- ========= File helper =========
    local function ensureFolders(self)
        local base = self.Folder
        local paths = { base, base .. "/settings" }
        for _, p in ipairs(paths) do
            if not isfolder(p) then
                local ok, err = pcall(makefolder, p)
                if not ok then warn("[SaveManager] makefolder failed:", p, err) end
            end
        end
    end

    function SaveManager:GetAutosavePath()
        return self.Folder .. "/" .. self.FileName
    end

    local function dbg(self, ...)
        if self._debug then print("[SaveManager]", ...) end
    end

    -- ========= Lua serialize =========
    local function escape_str(s)
        return string.format("%q", tostring(s))
    end

    local function is_array(tbl)
        if type(tbl) ~= "table" then return false end
        local i = 0
        for k,_ in pairs(tbl) do
            if type(k) ~= "number" then return false end
            if k > i then i = k end
        end
        for idx = 1, i do
            if tbl[idx] == nil then return false end
        end
        return true
    end

    local function serialize_lua(v, indent)
        indent = indent or ""
        local t = type(v)
        if t == "nil" then
            return "nil"
        elseif t == "boolean" or t == "number" then
            return tostring(v)
        elseif t == "string" then
            return escape_str(v)
        elseif t == "table" then
            local nextIndent = indent .. "  "
            if is_array(v) then
                local items = {}
                for i = 1, #v do
                    items[#items+1] = serialize_lua(v[i], nextIndent)
                end
                return "{ " .. table.concat(items, ", ") .. " }"
            else
                local parts = {}
                for k,val in pairs(v) do
                    local key
                    if type(k) == "string" and k:match("^[%a_][%w_]*$") then
                        key = k
                    else
                        key = "[" .. serialize_lua(k, nextIndent) .. "]"
                    end
                    parts[#parts+1] = string.format("%s%s = %s", nextIndent, key, serialize_lua(val, nextIndent))
                end
                if #parts == 0 then return "{}" end
                return "{\n" .. table.concat(parts, ",\n") .. "\n" .. indent .. "}"
            end
        else
            return escape_str(tostring(v))
        end
    end

    local function write_lua_table(path, tbl)
        local payload = "return " .. serialize_lua(tbl) .. "\n"
        local ok, err = pcall(writefile, path, payload)
        if not ok then warn("[SaveManager] writefile failed:", err) end
    end

    local function read_lua_table(path)
        if not isfile(path) then return nil end
        local ok, content = pcall(readfile, path)
        if not ok or type(content) ~= "string" then return nil end
        local fn, loadErr = loadstring(content)
        if not fn then
            warn("[SaveManager] loadstring autosave.lua failed:", loadErr)
            return nil
        end
        local ok2, result = pcall(fn)
        if not ok2 or type(result) ~= "table" then return nil end
        return result
    end

    -- ========= Flag helper =========
    local function isSavableFlag(flag)
        if typeof(flag) ~= "table" then return false end
        local t = string.lower(tostring(flag.Type or ""))
        return (t=="toggle" or t=="dropdown" or t=="multidropdown" or t=="input" or t=="slider")
    end

    local function getFlagValue(flag) return rawget(flag, "Value") end

    local function setFlagValue(flag, value)
        if typeof(flag) ~= "table" then return false end
        if typeof(flag.SetValue) == "function" then
            local ok = pcall(function() flag:SetValue(value) end)
            if ok then return true end
        end
        if rawget(flag, "Value") ~= nil then
            flag.Value = value
            if typeof(flag.OnChanged) == "function" then pcall(function() flag:OnChanged() end) end
            return true
        end
        return false
    end

    -- ========= Public API =========
    function SaveManager:SetFolder(folder)
        self.Folder = tostring(folder or self.Folder)
        ensureFolders(self)
        local path = self:GetAutosavePath()
        if not isfile(path) then write_lua_table(path, {}) end
    end

    function SaveManager:SetLibrary(lib) self.Library = lib end
    function SaveManager:SetIgnoreIndexes(t) self.IgnoreIndexes = t or {} end

    -- ========= Hook all flags (autosave) =========
    local hooked = {}
    function SaveManager:_HookAllOptions()
        task.spawn(function()
            while task.wait(0.25) do
                local flags = self.Library and self.Library.Flags
                if typeof(flags) ~= "table" then continue end

                for key, flag in pairs(flags) do
                    if isSavableFlag(flag) and not hooked[flag] then
                        hooked[flag] = true

                        -- áp giá trị đã lưu ngay khi phát hiện
                        local saved = self.Options and self.Options[key]
                        if saved ~= nil then
                            self._suppressSave = true
                            pcall(setFlagValue, flag, saved)
                            task.defer(function() self._suppressSave = false end)
                        end

                        local function saveNow()
                            if self._suppressSave then return end
                            self.Options[key] = getFlagValue(flag)
                            self:Save()
                        end

                        -- Gắn event nếu có
                        if typeof(flag.OnChanged) == "function" then
                            local ok, _ = pcall(function()
                                return flag:OnChanged(function(...) saveNow() end)
                            end)
                            if not ok then
                                local old = flag.OnChanged
                                flag.OnChanged = function(...)
                                    local ok2, err = pcall(old, ...)
                                    if not ok2 then warn("[SaveManager] OnChanged error:", err) end
                                    saveNow()
                                end
                            end
                        end

                        -- Fallback polling
                        task.spawn(function()
                            local function dump(v)
                                local ok, s = pcall(HttpService.JSONEncode, HttpService, v)
                                return ok and s or tostring(v)
                            end
                            local last = dump(getFlagValue(flag))
                            while hooked[flag] do
                                task.wait(0.5)
                                local cur = dump(getFlagValue(flag))
                                if cur ~= last and not self._suppressSave then
                                    last = cur
                                    self.Options[key] = getFlagValue(flag)
                                    self:Save()
                                end
                            end
                        end)
                    end
                end
            end
        end)
    end

    -- ========= Save / Load =========
    function SaveManager:Save()
        if self._suppressSave then return end
        ensureFolders(self)

        local data = {}
        local flags = self.Library and self.Library.Flags
        if typeof(flags) == "table" then
            for key, flag in pairs(flags) do
                if self.IgnoreIndexes[key] ~= true and isSavableFlag(flag) then
                    local v = getFlagValue(flag)
                    if v ~= nil then data[key] = v end
                end
            end
        end

        self.Options = data
        write_lua_table(self:GetAutosavePath(), data)
        dbg(self, "Saved to", self:GetAutosavePath())
    end

    function SaveManager:Load()
        ensureFolders(self)
        local path = self:GetAutosavePath()
        if not isfile(path) then write_lua_table(path, {}) return end

        local decoded = read_lua_table(path)
        if type(decoded) ~= "table" then return end

        self._suppressSave = true
        self.Options = decoded

        local flags = self.Library and self.Library.Flags
        if typeof(flags) == "table" then
            for key, val in pairs(decoded) do
                local flag = flags[key]
                if flag and isSavableFlag(flag) then
                    pcall(setFlagValue, flag, val)
                end
            end
        end
        task.defer(function() self._suppressSave = false end)
    end

    -- ========= Settings JSON phụ =========
    function SaveManager:SaveSettings()
        if self._suppressSave then return end
        ensureFolders(self)
        local ok, err = pcall(writefile, self.Folder .. "/settings/" .. self.SettingsFile, HttpService:JSONEncode(self.Settings))
        if not ok then warn("[SaveManager] write settings failed:", err) end
    end

    function SaveManager:LoadSettings()
        ensureFolders(self)
        local p = self.Folder .. "/settings/" .. self.SettingsFile
        if not isfile(p) then
            local ok, err = pcall(writefile, p, "{}")
            if not ok then warn("[SaveManager] create settings file failed:", err) end
            return
        end
        local ok, content = pcall(readfile, p)
        if not ok then warn("[SaveManager] read settings failed:", content) return end
        local ok2, decoded = pcall(HttpService.JSONDecode, HttpService, content)
        if ok2 and type(decoded)=="table" then self.Settings = decoded end
    end

    -- ========= Load + Hook =========
    function SaveManager:LoadWithPriority()
        self:LoadSettings()
        self:Load()
        self:_HookAllOptions()
        if not self._suppressSave then self:Save() end
    end

    function SaveManager:LoadAutoloadConfig() end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
