-- SaveManager.lua (robust: wait-for-options, method OnChanged hook, polling fallback, no empty overwrite)
local HttpService = game:GetService("HttpService")

-- Singleton guard (giữ 1 instance)
do
    local g = getgenv and getgenv() or _G
    if g.SaveManager and type(g.SaveManager)=="table" and g.SaveManager.__SM_SIGNATURE=="xal.save.v3" then
        return g.SaveManager
    end
end

local SaveManager = {} do
    SaveManager.__SM_SIGNATURE = "xal.save.v3"
    SaveManager.Folder = "FluentScriptHub/specific-game"
    SaveManager.FileName = "autosave.lua"

    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Ignore  = {}
    SaveManager._suppressSave = false
    SaveManager._ifaceBlock   = 0
    SaveManager._loading      = false
    SaveManager._debug        = false

    local function dbg(...) if SaveManager._debug then print("[SaveManager]", ...) end end
    local function ensureFolder(p) if not isfolder(p) then pcall(makefolder,p) end end
    local function autosavePath() return SaveManager.Folder.."/"..SaveManager.FileName end
    local function ensureFile(path) if not isfile(path) then pcall(writefile, path, "return {}\n") end end

    local function serialize(v, indent)
        indent = indent or ""
        local tv = typeof(v)
        if tv=="nil" or tv=="boolean" or tv=="number" then return tostring(v)
        elseif tv=="string" then return string.format("%q", v)
        elseif tv=="table" then
            local nextIndent = indent.."  "
            local parts = {}
            for k,val in pairs(v) do
                local key = (type(k)=="string" and k:match("^[%a_][%w_]*$")) and k or "["..serialize(k,nextIndent).."]"
                parts[#parts+1] = string.format("%s%s = %s", nextIndent, key, serialize(val,nextIndent))
            end
            if #parts==0 then return "{}" end
            return "{\n"..table.concat(parts, ",\n").."\n"..indent.."}"
        else
            return string.format("%q", tostring(v))
        end
    end
    local function read_lua_table(path)
        if not isfile(path) then return {} end
        local ok, src = pcall(readfile, path); if not ok then return {} end
        local fn, e = loadstring(src); if not fn then warn("[SaveManager] parse autosave.lua failed:", e) return {} end
        local ok2, res = pcall(fn); if not ok2 or type(res)~="table" then return {} end
        return res
    end
    local function write_lua_table(path, tbl)
        local ok, err = pcall(writefile, path, "return "..serialize(tbl).."\n")
        if not ok then warn("[SaveManager] write autosave.lua failed:", err) end
    end

    local function isBlocked(self)
        return self._suppressSave == true
            or (self._ifaceBlock or 0) > 0
            or self._loading == true
            or getgenv().__IFACE_CLOSING == true
    end
    local function hasAny(t) for _ in pairs(t or {}) do return true end return false end
    local function getFlags(self)
        local L = self.Library
        return (L and (L.Flags or L.Options)) or {}
    end

    function SaveManager:_IfaceBlockOn()  self._ifaceBlock = (self._ifaceBlock or 0) + 1 end
    function SaveManager:_IfaceBlockOff() self._ifaceBlock = math.max(0, (self._ifaceBlock or 0) - 1) end

    function SaveManager:SetIgnoreIndexes(list)
        self.Ignore = {}
        for _,k in ipairs(list or {}) do self.Ignore[k] = true end
    end
    function SaveManager:SetFolder(folder)
        self.Folder = folder or self.Folder
        ensureFolder(self.Folder)
        ensureFile(autosavePath())
    end
    function SaveManager:SetLibrary(lib)
        self.Library = lib
        self.Options = getFlags(self)
    end

    function SaveManager:_WithSilentApply(fn)
        self._loading = true
        getgenv().__SAVE_APPLYING = true
        local ok, err = pcall(fn)
        getgenv().__SAVE_APPLYING = false
        self._loading = false
        if not ok then warn("[SaveManager] apply error:", err) end
    end

    local function getVal(opt)
        if typeof(opt)~="table" then return nil end
        return rawget(opt,"Value")
    end
    local function setVal(opt, v)
        if typeof(opt)~="table" then return end
        if typeof(opt.SetValue)=="function" then pcall(function() opt:SetValue(v) end)
        else opt.Value = v end
    end

    function SaveManager:_readAll()
        ensureFolder(self.Folder); ensureFile(autosavePath())
        return read_lua_table(autosavePath())
    end
    function SaveManager:_writeAll(tbl)
        ensureFolder(self.Folder); ensureFile(autosavePath())
        write_lua_table(autosavePath(), tbl)
        dbg("wrote autosave.lua")
    end
    function SaveManager:_writeKey(key, v)
        if isBlocked(self) then return end
        if self.Ignore and self.Ignore[key] then return end
        local t = self:_readAll(); t[key]=v; self:_writeAll(t)
    end

    function SaveManager:_applyAllToOptions()
        local t = self:_readAll()
        self:_WithSilentApply(function()
            local opts = getFlags(self)
            for k,v in pairs(t) do
                if not (self.Ignore and self.Ignore[k]) then
                    local o = opts[k]; if o then pcall(setVal, o, v) end
                end
            end
        end)
    end

    -- Gắn theo kiểu Fluent: opt:OnChanged(cb), không overwrite thuộc tính
    local function attachChanged(opt, key)
        local attached = false
        -- Thử kiểu method `:OnChanged(cb)`
        local ok = pcall(function()
            if typeof(opt.OnChanged)=="function" then
                opt:OnChanged(function(...)
                    if getgenv().__IFACE_CLOSING or getgenv().__SAVE_APPLYING then return end
                    if isBlocked(SaveManager) then return end
                    task.defer(function()
                        SaveManager:_writeKey(key, getVal(opt))
                    end)
                end)
                attached = true
            end
        end)
        if attached then return true end

        -- Nếu không có method OnChanged, dùng polling dự phòng (được set bên dưới)
        return false
    end

    function SaveManager:_HookAutosave()
        task.spawn(function()
            while task.wait(0.25) do
                local flags = getFlags(self)
                if type(flags)~="table" or not hasAny(flags) then continue end
                for key, opt in pairs(flags) do
                    if self.Ignore and self.Ignore[key] then continue end
                    if typeof(opt)~="table" or opt.__sm_hooked then continue end
                    opt.__sm_hooked = true

                    -- 1) Ưu tiên attach kiểu Fluent
                    local okAttach = attachChanged(opt, key)

                    -- 2) Polling dự phòng nếu không attach được
                    task.spawn(function()
                        local last = HttpService:JSONEncode(getVal(opt))
                        while opt.__sm_hooked do
                            task.wait(0.5)
                            local cur = HttpService:JSONEncode(getVal(opt))
                            if cur ~= last then
                                last = cur
                                if not (getgenv().__IFACE_CLOSING or getgenv().__SAVE_APPLYING) and not isBlocked(SaveManager) then
                                    SaveManager:_writeKey(key, getVal(opt))
                                end
                            end
                        end
                    end)
                end
            end
        end)
    end

    -- Chờ options sẵn → apply im lặng → hook → snapshot khởi tạo (không ghi {} rỗng)
    function SaveManager:LoadWithPriority()
        task.spawn(function()
            local deadline = os.clock() + 10
            while os.clock() < deadline do
                self.Options = getFlags(self)
                if hasAny(self.Options) then break end
                task.wait(0.1)
            end

            self:_applyAllToOptions()
            self:_HookAutosave()

            -- snapshot ban đầu (nếu có ít nhất 1 key)
            local data = {}
            for k,opt in pairs(getFlags(self)) do
                if not (self.Ignore and self.Ignore[k]) then
                    local v = getVal(opt)
                    if v ~= nil then data[k] = v end
                end
            end
            if next(data) then self:_writeAll(data) end
        end)
    end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
