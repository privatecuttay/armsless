-- SaveManager.lua (Fluent g·ªëc + autosave.lua delta-write + LoadWithPriority)
local httpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "FluentSettings"
    SaveManager.Ignore = {}
    SaveManager.Parser = {
        Toggle = {
            Save = function(idx, object) return { type = "Toggle", idx = idx, value = object.Value } end,
            Load = function(idx, data) local o=SaveManager.Options[idx]; if o then o:SetValue(data.value) end end,
        },
        Slider = {
            Save = function(idx, object) return { type = "Slider", idx = idx, value = tostring(object.Value) } end,
            Load = function(idx, data) local o=SaveManager.Options[idx]; if o then o:SetValue(data.value) end end,
        },
        Dropdown = {
            Save = function(idx, object) return { type = "Dropdown", idx = idx, value = object.Value, mutli = object.Multi } end,
            Load = function(idx, data) local o=SaveManager.Options[idx]; if o then o:SetValue(data.value) end end,
        },
        Colorpicker = {
            Save = function(idx, object) return { type = "Colorpicker", idx = idx, value = object.Value:ToHex(), transparency = object.Transparency } end,
            Load = function(idx, data) local o=SaveManager.Options[idx]; if o then o:SetValueRGB(Color3.fromHex(data.value), data.transparency) end end,
        },
        Keybind = {
            Save = function(idx, object) return { type = "Keybind", idx = idx, mode = object.Mode, key = object.Value } end,
            Load = function(idx, data) local o=SaveManager.Options[idx]; if o then o:SetValue(data.key, data.mode) end end,
        },
        Input = {
            Save = function(idx, object) return { type = "Input", idx = idx, text = object.Value } end,
            Load = function(idx, data) local o=SaveManager.Options[idx]; if o and type(data.text)=="string" then o:SetValue(data.text) end end,
        },
    }

    ---------------------------------------------------------------------
    -- AUTOSAVE (lua table, delta-write)
    ---------------------------------------------------------------------
    SaveManager.AutoFileName = "autosave.lua"
    SaveManager._suppressSave = false
    SaveManager._debug = false

    local function dbg(...) if SaveManager._debug then print("[SaveManager]", ...) end end

    local function ensureFolders()
        local paths = { SaveManager.Folder, SaveManager.Folder .. "/settings" }
        for _, p in ipairs(paths) do
            if not isfolder(p) then pcall(makefolder, p) end
        end
    end
    local function autosavePath() return SaveManager.Folder .. "/" .. SaveManager.AutoFileName end

    local function esc(s) return string.format("%q", tostring(s)) end
    local function isarr(t)
        if type(t)~="table" then return false end
        local n=0; for k,_ in pairs(t) do if type(k)~="number" then return false end if k>n then n=k end end
        for i=1,n do if t[i]==nil then return false end end
        return true
    end
    local function ser(v, ind)
        ind = ind or ""
        local t=type(v)
        if t=="nil" then return "nil"
        elseif t=="boolean" or t=="number" then return tostring(v)
        elseif t=="string" then return esc(v)
        elseif t=="table" then
            local ni = ind.."  "
            if isarr(v) then
                local xs={}; for i=1,#v do xs[#xs+1]=ser(v[i],ni) end
                return "{ "..table.concat(xs,", ").." }"
            else
                local xs={}
                for k,val in pairs(v) do
                    local key = (type(k)=="string" and k:match("^[%a_][%w_]*$")) and k or ("["..ser(k,ni).."]")
                    xs[#xs+1]=string.format("%s%s = %s", ni, key, ser(val,ni))
                end
                if #xs==0 then return "{}" end
                return "{\n"..table.concat(xs,",\n").."\n"..ind.."}"
            end
        else return esc(tostring(v)) end
    end
    local function write_lua_table(path, tbl)
        local ok, err = pcall(writefile, path, "return "..ser(tbl).."\n")
        if not ok then warn("[SaveManager] writefile failed:", err) end
    end
    local function read_lua_table(path)
        if not isfile(path) then return nil end
        local ok, content = pcall(readfile, path); if not ok then return nil end
        local fn, e = loadstring(content); if not fn then warn("[SaveManager] loadstring failed:", e) return nil end
        local ok2, res = pcall(fn); if not ok2 or type(res)~="table" then return nil end
        return res
    end

    local function isSavableType(opt)
        local t = string.lower(tostring(opt and opt.Type or ""))
        return t=="toggle" or t=="dropdown" or t=="input" or t=="slider" or t=="multidropdown"
    end
    local function getOptionValue(opt)
        local keys = {"Value","CurrentValue","State","Text","Number","Selected"}
        for _,k in ipairs(keys) do local v=rawget(opt,k); if v~=nil then return v end end
        return nil
    end
    local function setOptionValue(opt, val)
        local setters = {"SetValue","Set","SetState","SetText","SetNumber","SetSelected"}
        for _,m in ipairs(setters) do local f=rawget(opt,m); if typeof(f)=="function" then pcall(f,opt,val); return true end end
        return false
    end

    function SaveManager:_ReadAutosave()
        ensureFolders()
        local p = autosavePath()
        if not isfile(p) then write_lua_table(p, {}) end
        return read_lua_table(p) or {}
    end
    function SaveManager:_WriteAutosave(tbl)
        ensureFolders()
        write_lua_table(autosavePath(), tbl or {})
        dbg("Autosave ->", autosavePath())
    end
    -- üîë delta-write: ch·ªâ ghi key v·ª´a thay ƒë·ªïi
    function SaveManager:_WriteAutosaveKey(key, value)
        if self._suppressSave then return end
        local tbl = self:_ReadAutosave()
        tbl[key] = value
        self:_WriteAutosave(tbl)
    end

    function SaveManager:_ApplyAutosaveToCurrentOptions()
        local data = self:_ReadAutosave()
        if type(data)~="table" or type(self.Options)~="table" then return end
        self._suppressSave = true
        for k,v in pairs(data) do
            local opt = self.Options[k]
            if opt and isSavableType(opt) then pcall(setOptionValue, opt, v) end
        end
        task.defer(function() self._suppressSave = false end)
    end

    local hooked = {}
    function SaveManager:_HookAutosave()
        task.spawn(function()
            while task.wait(0.25) do
                local opts = self.Options
                if type(opts) ~= "table" then continue end

                for key, opt in pairs(opts) do
                    if type(opt)=="table" and isSavableType(opt) and not hooked[opt] then
                        hooked[opt] = true

                        -- n·∫°p ri√™ng key n·∫øu ƒë√£ c√≥ trong autosave
                        local saved = self:_ReadAutosave()[key]
                        if saved ~= nil then
                            self._suppressSave = true
                            pcall(setOptionValue, opt, saved)
                            task.defer(function() self._suppressSave = false end)
                        end

                        local function saveThis()
                            if self._suppressSave then return end
                            self:_WriteAutosaveKey(key, getOptionValue(opt))
                        end

                        -- ∆∞u ti√™n API method: opt:OnChanged(cb)
                        local okMethod = false
                        if typeof(opt.OnChanged)=="function" then
                            okMethod = pcall(function()
                                return opt:OnChanged(function(...) saveThis() end)
                            end)
                        end
                        -- n·∫øu kh√¥ng ph·∫£i method, wrap field function
                        if not okMethod and typeof(opt.OnChanged)=="function" then
                            local old = opt.OnChanged
                            opt.OnChanged = function(...)
                                local ok, err = pcall(old, ...)
                                if not ok then warn("[SaveManager] OnChanged error:", err) end
                                saveThis()
                            end
                        end

                        -- fallback polling (ƒë·ªÅ ph√≤ng lib kh√¥ng g·ªçi OnChanged)
                        task.spawn(function()
                            local function dump(v) local ok,s=pcall(httpService.JSONEncode,httpService,v); return ok and s or tostring(v) end
                            local last = dump(getOptionValue(opt))
                            while hooked[opt] do
                                task.wait(0.5)
                                local cur = dump(getOptionValue(opt))
                                if cur ~= last and not SaveManager._suppressSave then
                                    last = cur
                                    SaveManager:_WriteAutosaveKey(key, getOptionValue(opt))
                                end
                            end
                        end)
                    end
                end
            end
        end)
    end

    -- T∆∞∆°ng th√≠ch v·ªõi main
    function SaveManager:LoadWithPriority()
        ensureFolders()
        if not isfile(autosavePath()) then write_lua_table(autosavePath(), {}) end
        if type(self.Options)=="table" then
            self:_ApplyAutosaveToCurrentOptions()
            self:_HookAutosave()
        end
    end

    ---------------------------------------------------------------------
    -- FUNCTIONS G·ªêC (config JSON th·ªß c√¥ng)
    ---------------------------------------------------------------------
    function SaveManager:SetIgnoreIndexes(list) for _,k in next, list do self.Ignore[k]=true end end

    function SaveManager:SetFolder(folder)
        self.Folder = folder
        ensureFolders()
        if not isfile(autosavePath()) then write_lua_table(autosavePath(), {}) end
    end

    function SaveManager:SetLibrary(library)
        self.Library = library
        self.Options = library.Options
        -- √°p autosave + hook ngay khi ƒë√£ c√≥ Options
        self:_ApplyAutosaveToCurrentOptions()
        self:_HookAutosave()
    end

    function SaveManager:Save(name)
        if not name then return false, "no config file is selected" end
        local fullPath = self.Folder .. "/settings/" .. name .. ".json"
        local data = { objects = {} }
        for idx, option in next, SaveManager.Options do
            if self.Parser[option.Type] and not self.Ignore[idx] then
                table.insert(data.objects, self.Parser[option.Type].Save(idx, option))
            end
        end
        local ok, encoded = pcall(httpService.JSONEncode, httpService, data)
        if not ok then return false, "failed to encode data" end
        writefile(fullPath, encoded)
        return true
    end

    function SaveManager:Load(name)
        if not name then return false, "no config file is selected" end
        local file = self.Folder .. "/settings/" .. name .. ".json"
        if not isfile(file) then return false, "invalid file" end

        local ok, decoded = pcall(httpService.JSONDecode, httpService, readfile(file))
        if not ok then return false, "decode error" end

        for _, option in next, decoded.objects do
            if self.Parser[option.type] then
                task.spawn(function() self.Parser[option.type].Load(option.idx, option) end)
            end
        end

        -- ƒë·ªìng b·ªô l·∫°i autosave v·ªõi ·∫£nh hi·ªán t·∫°i
        -- (kh√¥ng delta ·ªü ƒë√¢y ƒë·ªÉ file ph·∫£n √°nh tr·∫°ng th√°i v·ª´a load JSON)
        -- nh∆∞ng v·∫´n kh√¥ng ghi trong l√∫c GUI destroy v√¨ _suppressSave s·∫Ω true ·ªü InterfaceManager.
        local snapshot = {}
        for key,opt in pairs(self.Options) do
            if not self.Ignore[key] and isSavableType(opt) then
                snapshot[key] = getOptionValue(opt)
            end
        end
        self:_WriteAutosave(snapshot)

        return true
    end

    function SaveManager:BuildFolderTree()
        local paths = { self.Folder, self.Folder .. "/settings" }
        for _, p in ipairs(paths) do if not isfolder(p) then makefolder(p) end end
    end

    function SaveManager:RefreshConfigList()
        local list = listfiles(self.Folder .. "/settings")
        local out = {}
        for i = 1, #list do
            local file = list[i]
            if file:sub(-5) == ".json" then
                local pos = file:find(".json", 1, true)
                local start = pos
                local char = file:sub(pos, pos)
                while char ~= "/" and char ~= "\\" and char ~= "" do pos = pos - 1; char = file:sub(pos, pos) end
                if char == "/" or char == "\\" then
                    local name = file:sub(pos + 1, start - 1)
                    if name ~= "options" then table.insert(out, name) end
                end
            end
        end
        return out
    end

    function SaveManager:IgnoreThemeSettings()
        self:SetIgnoreIndexes({ "InterfaceTheme", "AcrylicToggle", "TransparentToggle", "MenuKeybind" })
    end

    function SaveManager:BuildConfigSection(tab)
        assert(self.Library, "Must set SaveManager.Library")

        local section = tab:AddSection("Configuration")
        section:AddInput("SaveManager_ConfigName",    { Title = "Config name" })
        section:AddDropdown("SaveManager_ConfigList", { Title = "Config list", Values = self:RefreshConfigList(), AllowNull = true })

        section:AddButton({ Title = "Create config", Callback = function()
            local name = SaveManager.Options.SaveManager_ConfigName.Value
            if name:gsub(" ","")=="" then
                return self.Library:Notify({ Title="Interface", Content="Config loader", SubContent="Invalid config name (empty)", Duration=7 })
            end
            local ok, err = self:Save(name)
            if not ok then
                return self.Library:Notify({ Title="Interface", Content="Config loader", SubContent="Failed to save config: "..tostring(err), Duration=7 })
            end
            self.Library:Notify({ Title="Interface", Content="Config loader", SubContent=string.format("Created config %q", name), Duration=7 })
            SaveManager.Options.SaveManager_ConfigList:SetValues(self:RefreshConfigList())
            SaveManager.Options.SaveManager_ConfigList:SetValue(nil)
        end })

        section:AddButton({ Title = "Load config", Callback = function()
            local name = SaveManager.Options.SaveManager_ConfigList.Value
            local ok, err = self:Load(name)
            if not ok then
                return self.Library:Notify({ Title="Interface", Content="Config loader", SubContent="Failed to load config: "..tostring(err), Duration=7 })
            end
            self.Library:Notify({ Title="Interface", Content="Config loader", SubContent=string.format("Loaded config %q", name), Duration=7 })
        end })

        section:AddButton({ Title = "Overwrite config", Callback = function()
            local name = SaveManager.Options.SaveManager_ConfigList.Value
            local ok, err = self:Save(name)
            if not ok then
                return self.Library:Notify({ Title="Interface", Content="Config loader", SubContent="Failed to overwrite config: "..tostring(err), Duration=7 })
            end
            self.Library:Notify({ Title="Interface", Content="Config loader", SubContent=string.format("Overwrote config %q", name), Duration=7 })
        end })

        section:AddButton({ Title = "Refresh list", Callback = function()
            SaveManager.Options.SaveManager_ConfigList:SetValues(self:RefreshConfigList())
            SaveManager.Options.SaveManager_ConfigList:SetValue(nil)
        end })

        local AutoloadButton
        AutoloadButton = section:AddButton({ Title = "Set as autoload", Description = "Current autoload config: none", Callback = function()
            local name = SaveManager.Options.SaveManager_ConfigList.Value
            writefile(self.Folder .. "/settings/autoload.txt", name)
            AutoloadButton:SetDesc("Current autoload config: " .. name)
            self.Library:Notify({ Title="Interface", Content="Config loader", SubContent=string.format("Set %q to auto load", name), Duration=7 })
        end })

        if isfile(self.Folder .. "/settings/autoload.txt") then
            local name = readfile(self.Folder .. "/settings/autoload.txt")
            AutoloadButton:SetDesc("Current autoload config: " .. name)
        end

        SaveManager:SetIgnoreIndexes({ "SaveManager_ConfigList", "SaveManager_ConfigName" })
    end

    SaveManager:BuildFolderTree()
end

return SaveManager
