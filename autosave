-- SaveManager.lua  (autosave.lua; l∆∞u theo h√†nh ƒë·ªông Toggle/Dropdown/Input/Slider)
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder       = "FluentScriptHub/specific-game"
    SaveManager.FileName     = "autosave.lua"      -- üîÑ d√πng .lua thay v√¨ .json
    SaveManager.SettingsFile = "options.json"      -- gi·ªØ nguy√™n cho ph·∫ßn Settings ph·ª•

    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Settings = {}
    SaveManager.IgnoreIndexes = {}
    SaveManager._suppressSave = false   -- ‚ö†Ô∏è InterfaceManager s·∫Ω b·∫≠t c·ªù n√†y khi reset toggle l√∫c GUI b·ªã xo√°

    -- ================= helpers: FS =================
    local function ensureFolders(self)
        local base = self.Folder
        local paths = { base, base .. "/settings" }
        for _, p in ipairs(paths) do
            if not isfolder(p) then
                local ok, err = pcall(makefolder, p)
                if not ok then warn("[SaveManager] makefolder failed:", p, err) end
            end
        end
    end

    local function optionsPath(self)  return self.Folder .. "/" .. self.FileName end
    local function settingsPath(self) return self.Folder .. "/settings/" .. self.SettingsFile end

    -- ================= helpers: Lua serialize/deserialize =================
    local function escape_str(s)
        return string.format("%q", tostring(s))
    end

    local function is_array(tbl)
        if type(tbl) ~= "table" then return false end
        local i = 0
        for k,_ in pairs(tbl) do
            if type(k) ~= "number" then return false end
            if k > i then i = k end
        end
        -- m·∫£ng ‚Äúchu·∫©n‚Äù n·∫øu ƒë·∫ßy ƒë·ªß 1..n
        for idx = 1, i do
            if tbl[idx] == nil then return false end
        end
        return true
    end

    local function serialize_lua(v, indent)
        indent = indent or ""
        local t = type(v)
        if t == "nil" then
            return "nil"
        elseif t == "boolean" or t == "number" then
            return tostring(v)
        elseif t == "string" then
            return escape_str(v)
        elseif t == "table" then
            local nextIndent = indent .. "  "
            if is_array(v) then
                local items = {}
                for i = 1, #v do
                    items[#items+1] = serialize_lua(v[i], nextIndent)
                end
                return "{ " .. table.concat(items, ", ") .. " }"
            else
                local parts = {}
                for k,val in pairs(v) do
                    local key
                    if type(k) == "string" and k:match("^[%a_][%w_]*$") then
                        key = k
                    else
                        key = "[" .. serialize_lua(k, nextIndent) .. "]"
                    end
                    parts[#parts+1] = string.format("%s%s = %s", nextIndent, key, serialize_lua(val, nextIndent))
                end
                if #parts == 0 then return "{}" end
                return "{\n" .. table.concat(parts, ",\n") .. "\n" .. indent .. "}"
            end
        else
            -- c√°c ki·ªÉu kh√¥ng l∆∞u ƒë∆∞·ª£c ‚Üí stringify
            return escape_str(tostring(v))
        end
    end

    local function write_lua_table(path, tbl)
        local payload = "return " .. serialize_lua(tbl) .. "\n"
        local ok, err = pcall(writefile, path, payload)
        if not ok then warn("[SaveManager] writefile failed:", err) end
    end

    local function read_lua_table(path)
        if not isfile(path) then return nil end
        local ok, content = pcall(readfile, path)
        if not ok or type(content) ~= "string" then return nil end
        local fn, loadErr = loadstring(content)
        if not fn then
            warn("[SaveManager] loadstring autosave.lua failed:", loadErr)
            return nil
        end
        local ok2, result = pcall(fn)
        if not ok2 or type(result) ~= "table" then return nil end
        return result
    end

    -- ================= helpers: Flags =================
    local function isSavableFlag(flag)
        if typeof(flag) ~= "table" then return false end
        local t = string.lower(tostring(flag.Type or ""))
        -- ch·ªâ l∆∞u: toggle / dropdown / multidropdown / input / slider
        return (t=="toggle" or t=="dropdown" or t=="multidropdown" or t=="input" or t=="slider")
    end

    local function getFlagValue(flag) return rawget(flag, "Value") end

    local function setFlagValue(flag, value)
        if typeof(flag) ~= "table" then return false end
        if typeof(flag.SetValue) == "function" then
            local ok = pcall(function() flag:SetValue(value) end)
            if ok then return true end
        end
        if rawget(flag, "Value") ~= nil then
            flag.Value = value
            if typeof(flag.OnChanged) == "function" then pcall(function() flag:OnChanged() end) end
            return true
        end
        return false
    end

    -- ================= PUBLIC API =================
    function SaveManager:SetFolder(folder)
        self.Folder = tostring(folder or self.Folder)
        ensureFolders(self)

        -- üîπ Kh·ªüi t·∫°o file r·ªóng autosave.lua n·∫øu ch∆∞a c√≥
        local op = optionsPath(self)
        if not isfile(op) then
            write_lua_table(op, {})  -- t·∫°o "return {}"
        end

        -- üîπ Kh·ªüi t·∫°o settings file (v·∫´n JSON) n·∫øu ch∆∞a c√≥
        local sp = settingsPath(self)
        if not isfile(sp) then
            local ok, err = pcall(writefile, sp, "{}")
            if not ok then warn("[SaveManager] init settings file failed:", err) end
        end
    end

    function SaveManager:SetLibrary(lib) self.Library = lib end
    function SaveManager:SetIgnoreIndexes(t) self.IgnoreIndexes = t or {} end

    -- T·ª± hook thay ƒë·ªïi ƒë·ªÉ L∆ØU NGAY m·ªói h√†nh ƒë·ªông b·∫≠t t·∫Øt / ch·ªçn / nh·∫≠p
    local hooked = {}
    function SaveManager:_HookAllOptions()
        task.spawn(function()
            while task.wait(0.25) do
                local flags = self.Library and self.Library.Flags
                if typeof(flags) ~= "table" then continue end

                for key, flag in pairs(flags) do
                    if isSavableFlag(flag) and not hooked[flag] then
                        hooked[flag] = true

                        local function saveNow()
                            -- ‚ùó B·ªé QUA l∆∞u khi GUI b·ªã xo√° (InterfaceManager set _suppressSave=true tr∆∞·ªõc khi reset toggle)
                            if self._suppressSave then return end
                            self.Options[key] = getFlagValue(flag)
                            self:Save()
                        end

                        if typeof(flag.OnChanged) == "function" then
                            -- b·ªçc OnChanged ƒë·ªÉ l∆∞u ngay ‚Äúh√†nh ƒë·ªông‚Äù
                            local old = flag.OnChanged
                            flag.OnChanged = function(...)
                                local ok, err = pcall(old, ...)
                                if not ok then warn("[SaveManager] OnChanged error:", err) end
                                saveNow()
                            end
                        else
                            -- Fallback: d√≤ thay ƒë·ªïi theo th·ªùi gian
                            task.spawn(function()
                                local function safeDump(v)
                                    -- d√πng JSON ch·ªâ ƒë·ªÉ so s√°nh s√¢u nhanh g·ªçn
                                    local ok, s = pcall(HttpService.JSONEncode, HttpService, v)
                                    return ok and s or tostring(v)
                                end
                                local last = safeDump(getFlagValue(flag))
                                while hooked[flag] do
                                    task.wait(0.5)
                                    local cur = safeDump(getFlagValue(flag))
                                    if cur ~= last and not self._suppressSave then
                                        last = cur
                                        self.Options[key] = getFlagValue(flag)
                                        self:Save()
                                    end
                                end
                            end)
                        end
                    end
                end
            end
        end)
    end

    function SaveManager:Save()
        if self._suppressSave then return end
        ensureFolders(self)

        local data = {}
        local flags = self.Library and self.Library.Flags
        if typeof(flags) == "table" then
            for key, flag in pairs(flags) do
                if self.IgnoreIndexes[key] ~= true and isSavableFlag(flag) then
                    local v = getFlagValue(flag)
                    if v ~= nil then data[key] = v end
                end
            end
        end

        self.Options = data
        write_lua_table(optionsPath(self), data)  -- üîÑ ghi ra autosave.lua
    end

    function SaveManager:Load()
        ensureFolders(self)
        local p = optionsPath(self)
        if not isfile(p) then
            write_lua_table(p, {})  -- t·∫°o "return {}" n·∫øu thi·∫øu
            return
        end

        local decoded = read_lua_table(p)
        if type(decoded) ~= "table" then return end

        self._suppressSave = true   -- tr√°nh ghi v√≤ng khi set l·∫°i flag
        self.Options = decoded

        local flags = self.Library and self.Library.Flags
        if typeof(flags) == "table" then
            for key, val in pairs(decoded) do
                local flag = flags[key]
                if flag and isSavableFlag(flag) then
                    pcall(setFlagValue, flag, val)
                end
            end
        end

        task.defer(function() self._suppressSave = false end)
    end

    -- ===== Settings ph·ª• (gi·ªØ JSON) =====
    function SaveManager:SaveSettings()
        if self._suppressSave then return end
        ensureFolders(self)
        local ok, err = pcall(writefile, settingsPath(self), HttpService:JSONEncode(self.Settings))
        if not ok then warn("[SaveManager] write settings failed:", err) end
    end

    function SaveManager:LoadSettings()
        ensureFolders(self)
        local p = settingsPath(self)
        if not isfile(p) then
            local okw, errw = pcall(writefile, p, "{}")
            if not okw then warn("[SaveManager] create settings file failed:", errw) end
            return
        end
        local ok, content = pcall(readfile, p)
        if not ok then warn("[SaveManager] read settings failed:", content) return end
        local ok2, decoded = pcall(HttpService.JSONDecode, HttpService, content)
        if ok2 and type(decoded)=="table" then self.Settings = decoded end
    end

    function SaveManager:LoadWithPriority()
        self:LoadSettings()
        self:Load()
        self:_HookAllOptions()
        -- √âp ghi 1 l·∫ßn ƒë·ªÉ ƒë·∫£m b·∫£o autosave.lua t·ªìn t·∫°i s·∫µn t·ª´ ƒë·∫ßu
        if not self._suppressSave then self:Save() end
    end

    function SaveManager:LoadAutoloadConfig() end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
