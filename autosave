-- SaveManager.lua (final stable sync with InterfaceManager)
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "FluentScriptHub/specific-game"
    SaveManager.FileName = "autosave.lua"
    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Ignore = {}
    SaveManager._suppressSave = false
    SaveManager._ifaceBlock = 0
    SaveManager._loading = false

    getgenv().__RESTORING_CONFIG = false

    -------------------------------------------------------------------
    local function ensureFolder(p) if not isfolder(p) then pcall(makefolder, p) end end
    local function path() return SaveManager.Folder .. "/" .. SaveManager.FileName end
    local function ensureFile(p) if not isfile(p) then pcall(writefile, p, "return {}\n") end end

    local function serialize(v, indent)
        indent = indent or ""
        local t = typeof(v)
        if t == "nil" or t == "boolean" or t == "number" then return tostring(v)
        elseif t == "string" then return string.format("%q", v)
        elseif t == "table" then
            local out, nextIndent = "{\n", indent .. "  "
            for k,val in pairs(v) do
                local key = (type(k)=="string" and k:match("^[%a_][%w_]*$")) and k or "["..serialize(k,nextIndent).."]"
                out ..= string.format("%s  %s = %s,\n", indent, key, serialize(val,nextIndent))
            end
            return out .. indent .. "}"
        end
        return string.format("%q", tostring(v))
    end

    local function read_lua(p)
        if not isfile(p) then return {} end
        local ok, src = pcall(readfile, p); if not ok then return {} end
        local fn, err = loadstring(src); if not fn then return {} end
        local ok2, res = pcall(fn); if not ok2 or type(res)~="table" then return {} end
        return res
    end
    local function write_lua(p, t)
        pcall(writefile, p, "return " .. serialize(t) .. "\n")
    end

    -------------------------------------------------------------------
    local function getFlags(self)
        return (self.Library and (self.Library.Flags or self.Library.Options)) or {}
    end
    local function getVal(opt)
        if typeof(opt)~="table" then return nil end
        return rawget(opt,"Value")
    end
    local function setVal(opt, v)
        if typeof(opt)~="table" then return end
        if typeof(opt.SetValue)=="function" then pcall(function() opt:SetValue(v) end)
        else opt.Value = v end
    end

    local function isBlocked(self)
        return self._suppressSave or self._loading or getgenv().__IFACE_CLOSING
    end

    -------------------------------------------------------------------
    function SaveManager:SetFolder(f)
        self.Folder = f or self.Folder
        ensureFolder(self.Folder)
        ensureFile(path())
    end
    function SaveManager:SetLibrary(lib)
        self.Library = lib
        self.Options = getFlags(self)
    end
    function SaveManager:SetIgnoreIndexes(list)
        self.Ignore = {}
        for _,k in ipairs(list or {}) do self.Ignore[k] = true end
    end

    -------------------------------------------------------------------
    -- ğŸ§  Apply config (UI true nhÆ°ng khÃ´ng cháº¡y callback)
    function SaveManager:_applyAll()
        ensureFolder(self.Folder)
        local tbl = read_lua(path())
        getgenv().__RESTORING_CONFIG = true
        self._loading = true
        for k,v in pairs(tbl) do
            if not self.Ignore[k] then
                local o = self.Options[k]
                if o then pcall(setVal, o, v) end
            end
        end
        task.delay(1, function()
            getgenv().__RESTORING_CONFIG = false
            self._loading = false
        end)
    end

    -------------------------------------------------------------------
    -- ğŸ§© Hook autosave
    function SaveManager:_Hook()
        task.spawn(function()
            while task.wait(0.25) do
                local flags = getFlags(self)
                for key, opt in pairs(flags) do
                    if self.Ignore[key] then continue end
                    if typeof(opt)~="table" or opt.__sm_hooked then continue end
                    opt.__sm_hooked = true

                    -- Fluent há»— trá»£ OnChanged method
                    local ok = pcall(function()
                        if typeof(opt.OnChanged)=="function" then
                            opt:OnChanged(function(...)
                                if getgenv().__RESTORING_CONFIG or isBlocked(SaveManager) then return end
                                local val = getVal(opt)
                                local t = read_lua(path())
                                t[key] = val
                                write_lua(path(), t)
                            end)
                        end
                    end)
                    if not ok then
                        -- polling fallback
                        task.spawn(function()
                            local last = HttpService:JSONEncode(getVal(opt))
                            while opt.__sm_hooked do
                                task.wait(0.5)
                                local now = HttpService:JSONEncode(getVal(opt))
                                if now ~= last and not getgenv().__RESTORING_CONFIG and not isBlocked(SaveManager) then
                                    last = now
                                    local t = read_lua(path())
                                    t[key] = getVal(opt)
                                    write_lua(path(), t)
                                end
                            end
                        end)
                    end
                end
            end
        end)
    end

    -------------------------------------------------------------------
    function SaveManager:LoadWithPriority()
        task.spawn(function()
            local start = os.clock()
            repeat task.wait(0.1)
                self.Options = getFlags(self)
            until next(self.Options) or os.clock()-start>10
            self:_applyAll()
            self:_Hook()
        end)
    end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
