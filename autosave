-- SaveManager.lua (auto-create autosave.json)123213
local HttpService = game:GetService("HttpService")

local SaveManager = {} do
    SaveManager.Folder = "FluentScriptHub/specific-game"
    SaveManager.FileName = "autosave.json"
    SaveManager.SettingsFile = "options.json"

    SaveManager.Library = nil
    SaveManager.Options = {}
    SaveManager.Settings = {}
    SaveManager.IgnoreIndexes = {}
    SaveManager._suppressSave = false

    local function ensureFolders(self)
        local base = self.Folder
        local paths = { base, base .. "/settings" }
        for _, p in ipairs(paths) do
            if not isfolder(p) then
                local ok, err = pcall(makefolder, p)
                if not ok then warn("[SaveManager] makefolder failed:", p, err) end
            end
        end
    end

    local function optionsPath(self)  return self.Folder .. "/" .. self.FileName end
    local function settingsPath(self) return self.Folder .. "/settings/" .. self.SettingsFile end

    local function jsonEncode(t)
        local ok, res = pcall(HttpService.JSONEncode, HttpService, t)
        if ok then return res else return "{}" end
    end
    local function jsonDecode(s)
        local ok, res = pcall(HttpService.JSONDecode, HttpService, s)
        if ok and type(res)=="table" then return res end
        return nil
    end

    local function isSavableFlag(flag)
        if typeof(flag) ~= "table" then return false end
        local t = string.lower(tostring(flag.Type or ""))
        return t=="toggle" or t=="dropdown" or t=="multidropdown" or
               t=="input" or t=="slider" or t=="colorpicker" or
               t=="keybind" or t=="checkbox" or t=="switch"
    end

    local function getFlagValue(flag) return rawget(flag,"Value") end
    local function setFlagValue(flag, value)
        if typeof(flag) ~= "table" then return false end
        if typeof(flag.SetValue) == "function" then
            local ok = pcall(function() flag:SetValue(value) end)
            if ok then return true end
        end
        if rawget(flag,"Value") ~= nil then
            flag.Value = value
            if typeof(flag.OnChanged) == "function" then pcall(function() flag:OnChanged() end) end
            return true
        end
        return false
    end

    -- ============ PUBLIC API ============
    function SaveManager:SetFolder(folder)
        self.Folder = tostring(folder or self.Folder)
        ensureFolders(self)
        -- üîπ Kh·ªüi t·∫°o file r·ªóng n·∫øu ch∆∞a c√≥
        local op = optionsPath(self)
        if not isfile(op) then
            local ok, err = pcall(writefile, op, "{}")
            if not ok then warn("[SaveManager] init autosave.json failed:", err) end
        end
        local sp = settingsPath(self)
        if not isfile(sp) then
            local ok, err = pcall(writefile, sp, "{}")
            if not ok then warn("[SaveManager] init settings file failed:", err) end
        end
    end

    function SaveManager:SetLibrary(lib) self.Library = lib end
    function SaveManager:SetIgnoreIndexes(t) self.IgnoreIndexes = t or {} end

    -- T·ª± hook thay ƒë·ªïi ƒë·ªÉ l∆∞u
    local hooked = {}
    function SaveManager:_HookAllOptions()
        task.spawn(function()
            while task.wait(0.25) do
                local flags = self.Library and self.Library.Flags
                if typeof(flags) ~= "table" then continue end
                for key, flag in pairs(flags) do
                    if isSavableFlag(flag) and not hooked[flag] then
                        hooked[flag] = true
                        local function saveNow()
                            if self._suppressSave then return end
                            self.Options[key] = getFlagValue(flag)
                            self:Save()
                        end
                        if typeof(flag.OnChanged) == "function" then
                            local old = flag.OnChanged
                            flag.OnChanged = function(...)
                                local ok, err = pcall(old, ...)
                                if not ok then warn("[SaveManager] OnChanged error:", err) end
                                saveNow()
                            end
                        else
                            -- Fallback: d√≤ thay ƒë·ªïi theo th·ªùi gian
                            task.spawn(function()
                                local last = jsonEncode(getFlagValue(flag))
                                while hooked[flag] do
                                    task.wait(0.5)
                                    local cur = jsonEncode(getFlagValue(flag))
                                    if cur ~= last and not self._suppressSave then
                                        last = cur
                                        self.Options[key] = getFlagValue(flag)
                                        self:Save()
                                    end
                                end
                            end)
                        end
                    end
                end
            end
        end)
    end

    function SaveManager:Save()
        if self._suppressSave then return end
        ensureFolders(self)
        local data = {}

        local flags = self.Library and self.Library.Flags
        if typeof(flags) == "table" then
            for key, flag in pairs(flags) do
                if self.IgnoreIndexes[key] ~= true and isSavableFlag(flag) then
                    local v = getFlagValue(flag)
                    if v ~= nil then data[key] = v end
                end
            end
        end

        self.Options = data
        local payload = jsonEncode(data)
        local ok, err = pcall(writefile, optionsPath(self), payload)
        if not ok then warn("[SaveManager] writefile failed:", err) end
    end

    function SaveManager:Load()
        ensureFolders(self)
        local p = optionsPath(self)
        if not isfile(p) then
            -- üîπ T·∫°o file tr·ªëng ngay l·∫≠p t·ª©c ƒë·ªÉ ƒë·∫£m b·∫£o t·ªìn t·∫°i
            local okw, errw = pcall(writefile, p, "{}")
            if not okw then warn("[SaveManager] create autosave.json failed:", errw) end
            return
        end
        local ok, content = pcall(readfile, p)
        if not ok then warn("[SaveManager] readfile failed:", content) return end
        local decoded = jsonDecode(content)
        if not decoded then return end

        self._suppressSave = true
        self.Options = decoded

        local flags = self.Library and self.Library.Flags
        if typeof(flags) == "table" then
            for key, val in pairs(decoded) do
                local flag = flags[key]
                if flag and isSavableFlag(flag) then
                    pcall(setFlagValue, flag, val)
                end
            end
        end
        task.defer(function() self._suppressSave = false end)
    end

    function SaveManager:SaveSettings()
        if self._suppressSave then return end
        ensureFolders(self)
        local ok, err = pcall(writefile, settingsPath(self), jsonEncode(self.Settings))
        if not ok then warn("[SaveManager] write settings failed:", err) end
    end

    function SaveManager:LoadSettings()
        ensureFolders(self)
        local p = settingsPath(self)
        if not isfile(p) then
            local okw, errw = pcall(writefile, p, "{}")
            if not okw then warn("[SaveManager] create settings file failed:", errw) end
            return
        end
        local ok, content = pcall(readfile, p)
        if not ok then warn("[SaveManager] read settings failed:", content) return end
        local decoded = jsonDecode(content)
        if decoded then self.Settings = decoded end
    end

    function SaveManager:LoadWithPriority()
        self:LoadSettings()
        self:Load()
        self:_HookAllOptions()
        -- üîπ √âp ghi 1 l·∫ßn ƒë·ªÉ ƒë·∫£m b·∫£o autosave.json t·ªìn t·∫°i ngay t·ª´ ƒë·∫ßu
        if not self._suppressSave then self:Save() end
    end

    function SaveManager:LoadAutoloadConfig() end
end

if getgenv then getgenv().SaveManager = SaveManager end
return SaveManager
