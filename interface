-- InterfaceManager.lua (no-duplicate GUI, clean destroy, block autosave on reset, optional Meo button)
local HttpService = game:GetService("HttpService")

-- ===== Mini Maid (cleanup utilities) =====
local Maid = {}; Maid.__index = Maid
function Maid.new() return setmetatable({tasks = {}}, Maid) end
function Maid:Give(x)
    local t
    if typeof(x)=="RBXScriptConnection" then
        t = function() pcall(function() x:Disconnect() end) end
    elseif typeof(x)=="Instance" then
        if typeof(x.Destroy)=="function" then t = function() pcall(function() x:Destroy() end) end end
    elseif type(x)=="table" and typeof(x.Cancel)=="function" then
        t = function() pcall(function() x:Cancel() end) end
    elseif type(x)=="function" then
        t = x
    end
    if t then table.insert(self.tasks, t) end
    return x
end
function Maid:DoCleaning()
    for i=#self.tasks,1,-1 do pcall(self.tasks[i]) end
    table.clear(self.tasks)
end

-- ==== tokens to stop task.spawn loops ====
getgenv().__TOKENS = getgenv().__TOKENS or { __GEN = 0 }

local function _ifaceBlockOn()
    local SM = rawget(getgenv(), "SaveManager")
    if SM then
        if typeof(SM._IfaceBlockOn)=="function" then SM:_IfaceBlockOn() else SM._suppressSave = true end
    end
end
local function _ifaceBlockOff()
    local SM = rawget(getgenv(), "SaveManager")
    if SM then
        if typeof(SM._IfaceBlockOff)=="function" then SM:_IfaceBlockOff() else SM._suppressSave = false end
    end
end

local InterfaceManager = {} do
    InterfaceManager.Folder = "FluentSettings"
    InterfaceManager.Settings = {
        Theme = "Dark",
        Acrylic = true,
        Transparency = true,
        MenuKeybind = "LeftControl",
    }

    -- reset all toggles to false (no save) â€” used only when GUI is closing
    local function _resetAllToggles_NoSave(Library)
        if not Library then return end
        local bags = {}
        if typeof(Library.Flags)=="table"   then table.insert(bags, Library.Flags)   end
        if typeof(Library.Options)=="table" then table.insert(bags, Library.Options) end

        for _, bag in ipairs(bags) do
            for _, flag in pairs(bag) do
                if typeof(flag)=="table" and (flag.Type=="Toggle" or flag.Type=="toggle") then
                    pcall(function()
                        if typeof(flag.SetValue)=="function" then flag:SetValue(false)
                        elseif rawget(flag,"Value")~=nil then flag.Value=false end
                    end)
                end
            end
        end
    end

    -- find existing Fluent GUI (avoid duplicates)
    local function _findExistingFluentGui()
        local CoreGui = game:GetService("CoreGui")
        local roots = { CoreGui }
        local ok, ui = pcall(function() return gethui and gethui() end)
        if ok and typeof(ui)=="Instance" then table.insert(roots, ui) end

        local robloxGui = CoreGui:FindFirstChild("RobloxGui")
        local function isSystemGui(inst) return robloxGui and inst:IsDescendantOf(robloxGui) end

        for _,root in ipairs(roots) do
            for _,g in ipairs(root:GetChildren()) do
                if g:IsA("ScreenGui") and not isSystemGui(g) then
                    if g:GetAttribute("Fluent")==true
                    or g.Name=="Fluent" or g.Name=="FluentUI"
                    or (g:FindFirstChild("AcrylicPaint", true) and g:FindFirstChild("Window", true)) then
                        return g
                    end
                end
            end
        end
        return nil
    end

    local function _attachAutoReset(Library)
        if not Library or Library.___AutoResetAttached then return end
        Library.___AutoResetAttached = true

        local gui = Library.GUI
        if not gui then return end
        pcall(function() gui:SetAttribute("Fluent", true) end)

        local maid = Maid.new()
        Library.___Maid = maid

        local function safeResetAndClean()
            getgenv().__IFACE_CLOSING = true
            _ifaceBlockOn()

            -- stop all guard-based loops
            getgenv().__TOKENS.__GEN = getgenv().__TOKENS.__GEN + 1

            -- optional: set all toggles to false silently for UI reflection
            _resetAllToggles_NoSave(Library)

            -- cleanup tracked connections/instances/tweens
            pcall(function() maid:DoCleaning() end)

            task.delay(1.0, function()
                getgenv().__IFACE_CLOSING = false
                _ifaceBlockOff()
            end)
        end

        if gui.Destroying then
            maid:Give(gui.Destroying:Connect(function() safeResetAndClean() end))
        end
        maid:Give(gui.AncestryChanged:Connect(function(_, parent)
            if parent == nil then safeResetAndClean() end
        end))
    end

    function InterfaceManager:SetFolder(folder)
        self.Folder = folder
        local parts = string.split(self.Folder, "/")
        local paths = {}
        for i=1,#parts do paths[#paths+1] = table.concat(parts, "/", 1, i) end
        table.insert(paths, self.Folder.."/settings")
        for _,p in ipairs(paths) do if not isfolder(p) then makefolder(p) end end
    end

    function InterfaceManager:SaveSettings()
        writefile(self.Folder.."/options.json", HttpService:JSONEncode(InterfaceManager.Settings))
    end
    function InterfaceManager:LoadSettings()
        local p = self.Folder.."/options.json"
        if isfile(p) then
            local ok, t = pcall(function() return HttpService:JSONDecode(readfile(p)) end)
            if ok and type(t)=="table" then for k,v in next, t do InterfaceManager.Settings[k]=v end end
        end
    end

    function InterfaceManager:SetLibrary(library)
        -- avoid duplicate GUI logic: if existing Fluent GUI found, prefer it
        local existingGui = _findExistingFluentGui()
        if existingGui then
            local running = rawget(getgenv(), "Fluent")
            if type(running)=="table" and running.GUI==existingGui then
                self.Library = running
            else
                self.Library = self.Library or { GUI = existingGui, Themes = {"Dark","Light"}, SetTheme=function() end }
            end
            _attachAutoReset(self.Library)
            -- destroy the incoming different library if any
            if library and library.GUI and library.GUI ~= existingGui then
                pcall(function()
                    if typeof(library.Destroy)=="function" then library:Destroy()
                    elseif library.GUI then library.GUI:Destroy() end
                end)
            end
            return
        end

        if self.Library and self.Library ~= library then
            pcall(function()
                if typeof(self.Library.Destroy)=="function" then self.Library:Destroy()
                elseif self.Library.GUI then self.Library.GUI:Destroy() end
            end)
        end
        self.Library = library
        _attachAutoReset(library)
    end

    function InterfaceManager:BuildInterfaceSection(tab)
        if not self or not self.Library then return end
        self:LoadSettings()
        local Library = self.Library
        local Settings = InterfaceManager.Settings

        local section = tab:AddSection("Interface")
        local themes = Library.Themes; if typeof(themes)~="table" or #themes==0 then themes={"Dark","Light"} end

        local InterfaceTheme = section:AddDropdown("InterfaceTheme", {
            Title = "Theme",
            Description = "Changes the interface theme.",
            Values = themes,
            Default = Settings.Theme,
            Callback = function(v)
                if typeof(Library.SetTheme)=="function" then Library:SetTheme(v) end
                Settings.Theme = v; InterfaceManager:SaveSettings()
            end
        })
        pcall(function() InterfaceTheme:SetValue(Settings.Theme) end)

        local MenuKeybind = section:AddKeybind("MenuKeybind", { Title = "Minimize Bind", Default = Settings.MenuKeybind })
        MenuKeybind:OnChanged(function()
            Settings.MenuKeybind = MenuKeybind.Value
            InterfaceManager:SaveSettings()
        end)
        Library.MinimizeKeybind = MenuKeybind
    end
end

return InterfaceManager
