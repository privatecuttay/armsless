#123
local httpService = game:GetService("HttpService")

local InterfaceManager = {} do
    InterfaceManager.Folder = "FluentScriptHub"
    InterfaceManager.Settings = {
        Theme = "Dark",
        Acrylic = true,
        Transparency = true,
        MenuKeybind = "LeftControl",
    }

    ---------------------------------------------------------------------
    -- ðŸ§¹ Close old GUI like manual close (handles acrylic removal)
    local function _destroyOldGui_likeManual()
        local CoreGui = game:GetService("CoreGui")
        local roots = { CoreGui, (gethui and gethui()) }

        getgenv().__IFACE_CLOSING = true

        local function tryClick(btn)
            if not btn then return false end
            local ok = false
            pcall(function()
                if getconnections then
                    local sigs = {}
                    if btn.MouseButton1Click then table.insert(sigs, btn.MouseButton1Click) end
                    if btn.Activated then table.insert(sigs, btn.Activated) end
                    for _, sig in ipairs(sigs) do
                        for _, c in ipairs(getconnections(sig)) do
                            c:Fire()
                            ok = true
                        end
                    end
                end
            end)
            if not ok then pcall(function() btn:Activate() ok = true end) end
            return ok
        end

        local function stripAcrylic(g)
            local names = { "Acrylic", "Backdrop", "Background", "Blur", "Overlay" }
            for _, d in ipairs(g:GetDescendants()) do
                if d:IsA("Frame") or d:IsA("ImageLabel") then
                    local match = false
                    for _, nm in ipairs(names) do
                        if string.find(string.lower(d.Name), string.lower(nm), 1, true) then
                            match = true; break
                        end
                    end
                    if match or (d.BackgroundTransparency and d.BackgroundTransparency < 1) then
                        pcall(function()
                            d.BackgroundTransparency = 1
                            if d:IsA("ImageLabel") then d.ImageTransparency = 1 end
                        end)
                    end
                end
            end
        end

        local function tryCloseWithDialog(g)
            local closeBtn = g:FindFirstChild("Close", true)
                          or g:FindFirstChild("ButtonClose", true)
                          or g:FindFirstChildWhichIsA("TextButton", true)
            if not closeBtn then return false end
            if not tryClick(closeBtn) then return false end
            task.wait(0.05)
            local yes
            for _, name in ipairs({ "Yes","Confirm","OK","Ok","Unload","Proceed" }) do
                local f = g:FindFirstChild(name, true)
                if f and f:IsA("TextButton") then yes = f break end
            end
            if yes then
                tryClick(yes)
                return true
            end
            return false
        end

        for _, root in ipairs(roots) do
            if typeof(root) ~= "Instance" then continue end
            for _, g in ipairs(root:GetChildren()) do
                if g:IsA("ScreenGui") and (g.Name == "Fluent" or g:GetAttribute("Fluent")) then
                    local closed = false
                    pcall(function() closed = tryCloseWithDialog(g) end)
                    if not closed then
                        pcall(function() stripAcrylic(g) end)
                        pcall(function() g:Destroy() end)
                    end
                end
            end
        end

        for _, root in ipairs(roots) do
            if typeof(root) == "Instance" then
                local mb = root:FindFirstChild("Meo_Button")
                if mb then pcall(function() mb:Destroy() end) end
            end
        end

        task.defer(function() getgenv().__IFACE_CLOSING = false end)
    end

    ---------------------------------------------------------------------
    -- ðŸ¾ Meo Button (floating toggle)
    local function _makeMeoButton(Settings, anchor)
        local VIM = game:GetService("VirtualInputManager")
        local UIS = game:GetService("UserInputService")
        local TweenService = game:GetService("TweenService")
        local parent = (gethui and gethui()) or game:GetService("CoreGui")

        local gui = Instance.new("ScreenGui")
        gui.Name = "Meo_Button"
        gui.IgnoreGuiInset = true
        gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
        gui.ResetOnSpawn = false
        gui.Parent = parent

        local btn = Instance.new("ImageButton")
        btn.Name = "CtrlSquare"
        btn.Size = UDim2.fromOffset(50, 50)
        btn.AnchorPoint = Vector2.new(1, 1)
        btn.Position = UDim2.new(1, -20, 1, -20)
        btn.BackgroundColor3 = Color3.fromRGB(44, 44, 44)
        btn.Image = "rbxassetid://138537648998329"
        btn.ScaleType = Enum.ScaleType.Fit
        btn.AutoButtonColor = true
        btn.Parent = gui
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)
        local stroke = Instance.new("UIStroke", btn)
        stroke.Thickness = 1
        stroke.Color = Color3.fromRGB(200, 150, 180)

        local dragging, dragStart, startPos
        btn.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = i.Position
                startPos = btn.Position
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = i.Position - dragStart
                btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
        UIS.InputEnded:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
        end)

        local function bounce()
            local ti = TweenInfo.new(0.08, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local to = TweenInfo.new(0.15, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
            TweenService:Create(btn, ti, {Size = UDim2.fromOffset(44,44)}):Play()
            task.wait(0.08)
            TweenService:Create(btn, to, {Size = UDim2.fromOffset(50,50)}):Play()
        end
        btn.MouseButton1Click:Connect(function()
            bounce()
            local key = Enum.KeyCode[Settings.MenuKeybind] or Enum.KeyCode.LeftControl
            VIM:SendKeyEvent(true, key, false, game)
            task.wait(0.05)
            VIM:SendKeyEvent(false, key, false, game)
        end)

        if anchor and anchor.Destroying then
            anchor.Destroying:Connect(function()
                if gui then pcall(function() gui:Destroy() end) end
            end)
        end
    end

    ---------------------------------------------------------------------
    function InterfaceManager:SetLibrary(lib)
        _destroyOldGui_likeManual()
        self.Library = lib
        pcall(function() lib.GUI:SetAttribute("Fluent", true) end)
        _makeMeoButton(self.Settings, lib.GUI)
        getgenv().__GUI_TOKEN = tostring(math.random(1e9))
    end

    function InterfaceManager:BuildInterfaceSection(tab)
        local Library = self.Library
        local Settings = self.Settings
        local section = tab:AddSection("Interface")

        local theme = section:AddDropdown("InterfaceTheme", {
            Title = "Theme",
            Values = Library.Themes,
            Default = Settings.Theme,
            Callback = function(v)
                Library:SetTheme(v)
                Settings.Theme = v
            end
        })
        theme:SetValue(Settings.Theme)

        local MenuKeybind = section:AddKeybind("MenuKeybind", {
            Title = "Minimize Bind",
            Default = Settings.MenuKeybind
        })
        MenuKeybind:OnChanged(function()
            Settings.MenuKeybind = MenuKeybind.Value
        end)
        Library.MinimizeKeybind = MenuKeybind
    end
end

return InterfaceManager
