-- InterfaceManager.lua
local httpService = game:GetService("HttpService")

local InterfaceManager = {} do
	InterfaceManager.Folder = "FluentSettings"
    InterfaceManager.Settings = {
        Theme = "Dark",
        Acrylic = true,
        Transparency = true,
        MenuKeybind = "LeftControl"
    }

    -- ===== reset all toggles to false, but DO NOT write save files =====
    local function _resetAllToggles_NoSave(Library)
        if not Library then return end

        local SM = rawget(getgenv(), "SaveManager")
        if SM and type(SM)=="table" then SM._suppressSave = true end

        local bags = {}
        if typeof(Library.Flags) == "table" then table.insert(bags, Library.Flags) end
        if typeof(Library.Options) == "table" then table.insert(bags, Library.Options) end

        for _, bag in ipairs(bags) do
            for _, flag in pairs(bag) do
                if typeof(flag) == "table" and (flag.Type == "Toggle" or flag.Type == "toggle") then
                    pcall(function()
                        if typeof(flag.SetValue) == "function" then
                            flag:SetValue(false)
                        elseif rawget(flag, "Value") ~= nil then
                            flag.Value = false
                        end
                    end)
                end
            end
        end

        task.defer(function()
            local SM2 = rawget(getgenv(), "SaveManager")
            if SM2 and type(SM2)=="table" then SM2._suppressSave = false end
        end)
    end

    local function _destroyOldGuis(excluding)
        local CoreGui = game:GetService("CoreGui")
        local roots = { CoreGui }
        local ok, ui = pcall(function() return gethui and gethui() end)
        if ok and typeof(ui)=="Instance" then table.insert(roots, ui) end

        local function looksLikeFluent(inst)
            if inst:GetAttribute("Fluent") == true then return true end
            if inst:FindFirstChild("AcrylicPaint", true) then return true end
            if inst:FindFirstChild("TopBar", true) and inst:FindFirstChild("Window", true) then return true end
            return false
        end

        for _,root in ipairs(roots) do
            for _,g in ipairs(root:GetChildren()) do
                if g ~= excluding and g:IsA("ScreenGui") and looksLikeFluent(g) then
                    pcall(function() g:Destroy() end)
                end
            end
            local btn = root:FindFirstChild("Meo_Button")
            if btn and btn ~= excluding then pcall(function() btn:Destroy() end) end
        end
    end

    local function _attachAutoReset(Library)
        if not Library then return end
        local gui = Library.GUI
        if not gui then return end
        if Library.___AutoResetAttached then return end
        Library.___AutoResetAttached = true

        pcall(function() gui:SetAttribute("Fluent", true) end)

        if gui.Destroying then
            gui.Destroying:Connect(function() _resetAllToggles_NoSave(Library) end)
        end
        gui.AncestryChanged:Connect(function(_, parent)
            if parent == nil then _resetAllToggles_NoSave(Library) end
        end)
    end
    -- ====================================

    function InterfaceManager:SetFolder(folder)
		self.Folder = folder;
		self:BuildFolderTree()
	end

    function InterfaceManager:SetLibrary(library)
        if self.Library and self.Library ~= library then
            pcall(function()
                if typeof(self.Library.Destroy) == "function" then
                    self.Library:Destroy()
                elseif self.Library.GUI then
                    self.Library.GUI:Destroy()
                end
            end)
            _resetAllToggles_NoSave(self.Library)
        end

        _destroyOldGuis(library and library.GUI)

		self.Library = library
        _attachAutoReset(library)
	end

    function InterfaceManager:BuildFolderTree()
		local paths = {}
		local parts = self.Folder:split("/")
		for idx = 1, #parts do
			paths[#paths + 1] = table.concat(parts, "/", 1, idx)
		end
		table.insert(paths, self.Folder)
		table.insert(paths, self.Folder .. "/settings")
		for i = 1, #paths do
			local str = paths[i]
			if not isfolder(str) then
				makefolder(str)
			end
		end
	end

    function InterfaceManager:SaveSettings()
        writefile(self.Folder .. "/options.json", httpService:JSONEncode(InterfaceManager.Settings))
    end

    function InterfaceManager:LoadSettings()
        local path = self.Folder .. "/options.json"
        if isfile(path) then
            local data = readfile(path)
            local success, decoded = pcall(httpService.JSONDecode, httpService, data)
            if success then
                for i, v in next, decoded do
                    InterfaceManager.Settings[i] = v
                end
            end
        end
    end

    function InterfaceManager:BuildInterfaceSection(tab)
        assert(self.Library, "Must set InterfaceManager.Library")
		local Library = self.Library
        local Settings = InterfaceManager.Settings

        InterfaceManager:LoadSettings()

		local section = tab:AddSection("Interface")

		local InterfaceTheme = section:AddDropdown("InterfaceTheme", {
			Title = "Theme",
			Description = "Changes the interface theme.",
			Values = Library.Themes,
			Default = Settings.Theme,
			Callback = function(Value)
				Library:SetTheme(Value)
                Settings.Theme = Value
                InterfaceManager:SaveSettings()
			end
		})
        InterfaceTheme:SetValue(Settings.Theme)

		local MenuKeybind = section:AddKeybind("MenuKeybind", { Title = "Minimize Bind", Default = Settings.MenuKeybind })
		MenuKeybind:OnChanged(function()
			Settings.MenuKeybind = MenuKeybind.Value
            InterfaceManager:SaveSettings()
		end)
		Library.MinimizeKeybind = MenuKeybind
    end
end

return InterfaceManager
