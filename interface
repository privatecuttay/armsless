-- InterfaceManager.lua123
local httpService = game:GetService("HttpService")

local InterfaceManager = {} do
	InterfaceManager.Folder = "FluentSettings"
    InterfaceManager.Settings = {
        Theme = "Dark",
        Acrylic = true,
        Transparency = true,
        MenuKeybind = "LeftControl"
    }

    -- üîÅ T·∫Øt t·∫•t c·∫£ toggle v·ªÅ false nh∆∞ng KH√îNG ghi file
    local function _resetAllToggles_NoSave(Library)
        if not Library then return end
        local SM = rawget(getgenv(), "SaveManager")
        if SM and type(SM)=="table" then SM._suppressSave = true end

        local bags = {}
        if typeof(Library.Flags) == "table"   then table.insert(bags, Library.Flags)   end
        if typeof(Library.Options) == "table" then table.insert(bags, Library.Options) end

        for _, bag in ipairs(bags) do
            for _, flag in pairs(bag) do
                if typeof(flag) == "table" and (flag.Type == "Toggle" or flag.Type == "toggle") then
                    pcall(function()
                        if typeof(flag.SetValue) == "function" then
                            flag:SetValue(false)
                        elseif rawget(flag, "Value") ~= nil then
                            flag.Value = false
                        end
                    end)
                end
            end
        end

        task.defer(function()
            local SM2 = rawget(getgenv(), "SaveManager")
            if SM2 and type(SM2)=="table" then SM2._suppressSave = false end
        end)
    end

    -- üîé T√¨m Fluent GUI ƒëang t·ªìn t·∫°i (kh√¥ng ƒë·ª•ng SettingsHub)
    local function _findExistingFluentGui()
        local CoreGui = game:GetService("CoreGui")
        local roots = { CoreGui }
        local ok, ui = pcall(function() return gethui and gethui() end)
        if ok and typeof(ui)=="Instance" then table.insert(roots, ui) end

        local robloxGui = CoreGui:FindFirstChild("RobloxGui")
        local function isSystemGui(inst) return robloxGui and inst:IsDescendantOf(robloxGui) end

        for _,root in ipairs(roots) do
            for _,g in ipairs(root:GetChildren()) do
                if g:IsA("ScreenGui") and not isSystemGui(g) then
                    if g:GetAttribute("Fluent") == true
                    or g.Name == "Fluent" or g.Name == "FluentUI"
                    or (g:FindFirstChild("AcrylicPaint", true) and g:FindFirstChild("Window", true)) then
                        return g
                    end
                end
            end
        end
        return nil
    end

    -- üîó G·∫Øn auto-reset khi GUI b·ªã x√≥a
    local function _attachAutoReset(Library)
        if not Library then return end
        local gui = Library.GUI
        if not gui then return end
        if Library.___AutoResetAttached then return end
        Library.___AutoResetAttached = true

        pcall(function() gui:SetAttribute("Fluent", true) end)

        if gui.Destroying then
            gui.Destroying:Connect(function() _resetAllToggles_NoSave(Library) end)
        end
        gui.AncestryChanged:Connect(function(_, parent)
            if parent == nil then _resetAllToggles_NoSave(Library) end
        end)
    end

    -- ========= InterfaceManager core =========
    function InterfaceManager:SetFolder(folder)
		self.Folder = folder
		self:BuildFolderTree()
	end

    function InterfaceManager:SetLibrary(library)
        -- ‚ùó N·∫øu ƒë√£ c√≥ Fluent GUI kh√°c t·ªìn t·∫°i ‚Üí kh√¥ng t·∫°o th√™m, h·ªßy library m·ªõi
        local existingGui = _findExistingFluentGui()
        if existingGui and library and library.GUI and existingGui ~= library.GUI then
            print("‚ö†Ô∏è GUI Fluent ƒë√£ c√≥ s·∫µn, kh√¥ng t·∫°o th√™m.")
            pcall(function()
                if typeof(library.Destroy) == "function" then
                    library:Destroy()
                elseif library.GUI then
                    library.GUI:Destroy()
                end
            end)
            return -- gi·ªØ nguy√™n self.Library (b·∫£n c≈©)
        end

        -- N·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ c√≥ Library kh√°c v√† b·∫°n ƒëang thay th·∫ø ‚Üí t·∫Øt toggle b·∫£n c≈©
        if self.Library and self.Library ~= library then
            pcall(function()
                if typeof(self.Library.Destroy) == "function" then
                    self.Library:Destroy()
                elseif self.Library.GUI then
                    self.Library.GUI:Destroy()
                end
            end)
            _resetAllToggles_NoSave(self.Library)
        end

        self.Library = library
        _attachAutoReset(library)
	end

    function InterfaceManager:BuildFolderTree()
		local paths, parts = {}, self.Folder:split("/")
		for idx = 1, #parts do
			paths[#paths + 1] = table.concat(parts, "/", 1, idx)
		end
		table.insert(paths, self.Folder)
		table.insert(paths, self.Folder .. "/settings")
		for _, p in ipairs(paths) do
			if not isfolder(p) then makefolder(p) end
		end
	end

    function InterfaceManager:SaveSettings()
        writefile(self.Folder .. "/options.json", httpService:JSONEncode(InterfaceManager.Settings))
    end

    function InterfaceManager:LoadSettings()
        local path = self.Folder .. "/options.json"
        if isfile(path) then
            local ok, decoded = pcall(function()
                return httpService:JSONDecode(readfile(path))
            end)
            if ok and type(decoded)=="table" then
                for k,v in next, decoded do
                    InterfaceManager.Settings[k] = v
                end
            end
        end
    end

    -- ========= UI Section =========
    function InterfaceManager:BuildInterfaceSection(tab)
        assert(self.Library, "Must set InterfaceManager.Library")
		local Library = self.Library
        local Settings = InterfaceManager.Settings
        InterfaceManager:LoadSettings()

		local section = tab:AddSection("Interface")

		local InterfaceTheme = section:AddDropdown("InterfaceTheme", {
			Title = "Theme",
			Description = "Changes the interface theme.",
			Values = Library.Themes,
			Default = Settings.Theme,
			Callback = function(Value)
				Library:SetTheme(Value)
                Settings.Theme = Value
                InterfaceManager:SaveSettings()
			end
		})
        InterfaceTheme:SetValue(Settings.Theme)

		local MenuKeybind = section:AddKeybind("MenuKeybind", {
            Title = "Minimize Bind",
            Default = Settings.MenuKeybind
        })
		MenuKeybind:OnChanged(function()
			Settings.MenuKeybind = MenuKeybind.Value
            InterfaceManager:SaveSettings()
		end)
		Library.MinimizeKeybind = MenuKeybind
    end
end

return InterfaceManager
