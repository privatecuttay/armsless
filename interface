--fix button2
local httpService = game:GetService("HttpService")

local InterfaceManager = {} do
    InterfaceManager.Folder = "FluentScriptHub"
    InterfaceManager.Settings = {
        Theme = "Dark",
        Acrylic = false,
        Transparency = true,
        MenuKeybind = "LeftControl", -- lu√¥n l√† string
    }

    local function _destroyOldGui_likeManual()
        local Players   = game:GetService("Players")
        local LP        = Players.LocalPlayer
        local PlayerGui = LP and LP:FindFirstChildOfClass("PlayerGui")

        getgenv().__IFACE_CLOSING = true

        if PlayerGui then
            for _, g in ipairs(PlayerGui:GetChildren()) do
                if g:IsA("ScreenGui") and (g.Name == "Fluent" or (g.GetAttribute and g:GetAttribute("Fluent"))) then
                    pcall(function()
                        for _, d in ipairs(g:GetDescendants()) do
                            if d:IsA("Frame") or d:IsA("ImageLabel") then
                                pcall(function()
                                    if d.BackgroundTransparency ~= nil then
                                        d.BackgroundTransparency = 1
                                    end
                                    if d:IsA("ImageLabel") and d.ImageTransparency ~= nil then
                                        d.ImageTransparency = 1
                                    end
                                end)
                            end
                        end
                    end)
                    pcall(function()
                        g:Destroy()
                    end)
                end
            end

            local mb = PlayerGui:FindFirstChild("Meo_Button")
            if mb then
                pcall(function()
                    mb:Destroy()
                end)
            end
        end

        task.defer(function()
            getgenv().__IFACE_CLOSING = false
        end)
    end

    local function _makeMeoButton(Settings, anchor)
        local VIM          = game:GetService("VirtualInputManager")
        local UIS          = game:GetService("UserInputService")
        local TweenService = game:GetService("TweenService")
        local Players      = game:GetService("Players")
        local LP           = Players.LocalPlayer
        local PlayerGui    = LP and LP:WaitForChild("PlayerGui")

        local gui = Instance.new("ScreenGui")
        gui.Name = "Meo_Button"
        gui.IgnoreGuiInset = true
        gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
        gui.ResetOnSpawn = false
        gui.Parent = PlayerGui

        local btn = Instance.new("ImageButton")
        btn.Name = "CtrlSquare"
        btn.Size = UDim2.fromOffset(50, 50)
        btn.AnchorPoint = Vector2.new(1, 1)
        btn.Position = UDim2.new(1, -20, 1, -20)
        btn.BackgroundTransparency = 1
        btn.Image = "rbxassetid://116072339339658"
        btn.ScaleType = Enum.ScaleType.Fit
        btn.AutoButtonColor = true
        btn.Parent = gui

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 10)
        corner.Parent = btn

        local stroke = Instance.new("UIStroke")
        stroke.Thickness = 2
        stroke.Color = Color3.fromRGB(250, 230, 150)
        stroke.Parent = btn

        -- Drag
        local dragging, dragStart, startPos
        btn.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = i.Position
                startPos = btn.Position
            end
        end)

        UIS.InputChanged:Connect(function(i)
            if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
                local d = i.Position - dragStart
                btn.Position = UDim2.new(
                    startPos.X.Scale,
                    startPos.X.Offset + d.X,
                    startPos.Y.Scale,
                    startPos.Y.Offset + d.Y
                )
            end
        end)

        UIS.InputEnded:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)

        local function bounce()
            local ti = TweenInfo.new(0.08, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local to = TweenInfo.new(0.15, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
            game:GetService("TweenService"):Create(btn, ti, { Size = UDim2.fromOffset(44, 44) }):Play()
            task.wait(0.08)
            game:GetService("TweenService"):Create(btn, to, { Size = UDim2.fromOffset(50, 50) }):Play()
        end

        btn.MouseButton1Click:Connect(function()
            bounce()

            local raw = Settings.MenuKeybind
            local key

            -- raw c√≥ th·ªÉ l√† string ho·∫∑c EnumItem (t√πy l√∫c load config)
            if typeof(raw) == "EnumItem" then
                key = raw
            elseif type(raw) == "string" then
                key = Enum.KeyCode[raw] or Enum.KeyCode.LeftControl
            else
                key = Enum.KeyCode.LeftControl
            end

            VIM:SendKeyEvent(true, key, false, game)
            task.wait(0.05)
            VIM:SendKeyEvent(false, key, false, game)
        end)

        if anchor then
            pcall(function()
                anchor.Destroying:Connect(function()
                    if gui then
                        pcall(function()
                            gui:Destroy()
                        end)
                    end
                end)
            end)
        end
    end

    function InterfaceManager:SetLibrary(lib)
        _destroyOldGui_likeManual()
        self.Library = lib

        pcall(function()
            lib.GUI:SetAttribute("Fluent", true)
        end)

        _makeMeoButton(self.Settings, lib.GUI)
        getgenv().__GUI_TOKEN = tostring(math.random(1e9))
    end

    function InterfaceManager:BuildInterfaceSection(tab)
        local Library  = self.Library
        local Settings = self.Settings
        local section  = tab:AddSection("Interface")

        -- Theme
        local theme = section:AddDropdown("InterfaceTheme", {
            Title   = "Theme",
            Values  = Library.Themes,
            Default = Settings.Theme,
        })
        theme:SetValue(Settings.Theme)

        theme:OnChanged(function(v)
            Library:SetTheme(v)
            Settings.Theme = v
        end)

        -- üîë MenuKeybind: Default d√πng string nh∆∞ th∆∞ vi·ªán g·ªëc
        local MenuKeybind = section:AddKeybind("MenuKeybind", {
            Title   = "Minimize Bind",
            Default = Settings.MenuKeybind, -- string: "LeftControl", "F", ...
        })

        MenuKeybind:OnChanged(function()
            local v = MenuKeybind.Value
            if typeof(v) == "EnumItem" then
                Settings.MenuKeybind = v.Name      -- l∆∞u "F"
            else
                Settings.MenuKeybind = tostring(v) -- fallback
            end
        end)

        Library.MinimizeKeybind = MenuKeybind
    end

    function InterfaceManager:BuildHopServerSection(tab)
        local section = tab:AddSection("Hop Server")

        section:AddButton({
            Title = "Rejoin Server",
            Callback = function()
                local TeleportService = game:GetService("TeleportService")
                local Players         = game:GetService("Players")
                local LP              = Players.LocalPlayer

                TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LP)
            end
        })

        section:AddButton({
            Title = "Hop New Server",
            Callback = function()
                local placeId = game.PlaceId
                local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100"):format(placeId)

                local ok, res = pcall(function()
                    return game:HttpGet(url)
                end)
                if not ok then return end

                local data = game:GetService("HttpService"):JSONDecode(res)
                if not data or not data.data then return end

                local TeleportService = game:GetService("TeleportService")
                local Players         = game:GetService("Players")
                local LP              = Players.LocalPlayer

                for _, v in ipairs(data.data) do
                    if v.playing < v.maxPlayers and v.id ~= game.JobId then
                        TeleportService:TeleportToPlaceInstance(placeId, v.id, LP)
                        break
                    end
                end
            end
        })
    end
end

return InterfaceManager
